
This file describes how to "mirror" the NCBI taxonomy database by creating
and populating MySQL tables (to be used in a compara database), that retain
the necessary information to generate the taxonomy tree structure used by
the Bio::EnsEMBL::Compara::NCBITaxon object (and its corresponding adaptor
Bio::EnsEMBL::Compara::DBSQL::NCBITaxonAdaptor).

The NCBI taxonomy database dumps are apparently generated every hour.
We'll update our "mirror" at each release (every 2 months).

wget ftp://ftp.ncbi.nih.gov/pub/taxonomy/taxdump.tar.gz

gtar xvzf taxdump.tar.gz

rm -f taxdump.tar.gz

perl -e 'while(<>) {chomp;s/\t\|$//;my @array = split(/\t\|\t/);my ($taxon_id, $parent_id, $rank, $genbank_hidden_flag) = ($array[0],$array[1],$array[2],$array[10]);print $taxon_id,"\t", $parent_id,"\t", $rank,"\t",$genbank_hidden_flag,"\n";}' nodes.dmp > ncbi_taxa_node.txt

perl -e 'while(<>) {chomp;s/\t\|$//;my ($taxon_id, $name, $unique_name, $name_class) = split(/\t\|\t/);print $taxon_id,"\t", $name,"\t",$name_class,"\n";}' names.dmp > ncbi_taxa_name.txt

mysql -hecs2 -P3365 -uensadmin -pensembl -N -e "create database ncbi_taxonomy"

CREATE TABLE ncbi_taxa_node (
  taxon_id                        int(10) unsigned NOT NULL,
  parent_id                       int(10) unsigned NOT NULL,

  rank                            char(32) default '' NOT NULL,
  genbank_hidden_flag             boolean default 0 NOT NULL,

  left_index                      int(10) NOT NULL,
  right_index                     int(10) NOT NULL,
  root_id                         int(10) default 1 NOT NULL,
  
  KEY (taxon_id),
  KEY (parent_id),
  KEY (rank)
);

CREATE TABLE ncbi_taxa_name (
  taxon_id                    int(10) unsigned NOT NULL,

  name                        varchar(255),
  name_class                  varchar(50),

  KEY (taxon_id),
  KEY (name),
  KEY (name_class)
);

mysqlimport -hecs2 -P3365 -uensadmin -pensembl ncbi_taxonomy ncbi_taxa_node.txt
ncbi_taxonomy.ncbi_taxa_node: Records: 296515  Deleted: 0  Skipped: 0  Warnings: 889545

mysqlimport -hecs2 -P3365 -uensadmin -pensembl ncbi_taxonomy ncbi_taxa_name.txt
ncbi_taxonomy.ncbi_taxa_name: Records: 385145  Deleted: 0  Skipped: 0  Warnings: 0

mysql -hecs2 -P3365 -uensadmin -pensembl -N -e "update ncbi_taxa_node set parent_id=0 where parent_id=taxon_id" ncbi_taxonomy

awk '{print $1,$3}' merged.dmp |awk '{print "insert into ncbi_taxa_name (taxon_id, name_class, name) values ("$2",\"merged_taxon_id\","$1");"}' > merged_nodes.sql

mysql -hecs2 -P3365 -uensadmin -pensembl ncbi_taxonomy < merged_nodes.sql

mysql -hecs2 -P3365 -uensadmin -pensembl -N -e "insert into ncbi_taxa_name (taxon_id, name, name_class) select distinct taxon_id, CURRENT_TIMESTAMP, 'import date' from ncbi_taxa_node where parent_id=0" ncbi_taxonomy

# Build the left/right indexes and store them in the database. This indexing help speeding up subtree retrivial if needed.

ensembl-compara/scripts/taxonomy/taxonTreeTool.pl -url mysql://ensadmin:ensembl@ecs2:3365/ncbi_taxonomy -index > leftright_indexing.err 2>&1 &

# Import 'ensembl common name' and 'ensembl alias name' for Ensembl web team use.

insert into ncbi_taxa_name (taxon_id, name, name_class) values (10116,"Rat","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (10116,"Norway rat","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (31033,"Fugu","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (31033,"torafugu","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7165,"Anopheles","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7165,"African malaria mosquito","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (6239,"C.elegans","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (6239,"nematode","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9031,"Chicken","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9031,"chicken","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (99883,"Tetraodon","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (99883,"Fresh water pufferfish","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9913,"Cow","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9913,"cattle","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (8364,"X.tropicalis","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (8364,"western clawed frog","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (4932,"S.cerevisiae","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (4932,"baker's yeast","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7719,"C.intestinalis","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7719,"Sea squirt Ciona intestinalis","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9606,"Human","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9606,"human","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7227,"Fruitfly","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7227,"fruit fly","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (10090,"Mouse","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (10090,"house mouse","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7955,"Zebrafish","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7955,"zebrafish","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (51511,"C.savignyi","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (51511,"Sea squirt Ciona savignyi","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (13616,"Opossum","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (13616,"gray short-tailed opossum","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7159,"Aedes","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (7159,"yellow fever mosquito","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9544,"Macaque","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9544,"rhesus monkey","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9785,"Elephant","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9785,"African savanna elephant","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9371,"Lesser hedgehog tenrec","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9371,"small Madagascar hedgehog","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9986,"Rabbit","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9986,"rabbit","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9361,"Armadillo","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9361,"nine-banded armadillo","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (69293,"Stickleback","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (69293,"three spined stickleback","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (8090,"Medaka","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (8090,"Japanese medaka","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9598,"Chimpanzee","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9598,"chimpanzee","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9615,"Dog","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9615,"dog","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9258,"Platypus","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9258,"platypus","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9823,"Pig","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9823,"pig","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9685,"Cat","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (9685,"cat","ensembl common name");

# Need to check these alias name with Web team
insert into ncbi_taxa_name (taxon_id, name, name_class) values (42254,"Shrew","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (42254,"European shrew","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (30611,"Galago","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (30611,"small-eared galago","ensembl common name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (59463,"Microbat","ensembl alias name");
insert into ncbi_taxa_name (taxon_id, name, name_class) values (59463,"little brown bat","ensembl common name");
