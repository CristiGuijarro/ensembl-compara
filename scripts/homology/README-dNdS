11. calculate dN and dS values
    --------------------------

Once each homology relationship is loaded to the compara database and only then we can calculate the
dN and dS value.
So far we only do that for human/mouse, human/rat, mouse/rat and elegans/briggsae.

We do that for all of them at once. So have all the paired species homologies loaded in compara.


 mkdir -p $WORKDIR/dNdS_20_1/homology_ids_dNdS $WORKDIR/dNdS_20_1/homology_ids_in \
 $WORKDIR/dNdS_20_1/homology_ids_out
 cd $WORKDIR/dNdS_20_1

Get all the homology_ids for which as dN, dS calculation is required
e.g. for human/mouse, taxon_id 9606 and 10090 repectively

echo "select hm1.homology_id from homology_member hm1,homology_member hm2,member m1,member m2 where hm1.homology_id=hm2.homology_id and hm1.member_id=m1.member_id and hm2.member_id=m2.member_id and m1.taxon_id=9606 and m2.taxon_id=10090;"|grep -v homology_id > 9606_10090.homology_ids

an so on for 9606/10116, 10090/10116 and 6239/6238

echo "select hm1.homology_id from homology_member hm1,homology_member hm2,member m1,member m2 where hm1.homology_id=hm2.homology_id and hm1.member_id=m1.member_id and hm2.member_id=m2.member_id and m1.taxon_id=9606 and m2.taxon_id=10116;"|grep -v homology_id > 9606_10116.homology_ids

echo "select hm1.homology_id from homology_member hm1,homology_member hm2,member m1,member m2 where hm1.homology_id=hm2.homology_id and hm1.member_id=m1.member_id and hm2.member_id=m2.member_id and m1.taxon_id=10090 and m2.taxon_id=10116;"|grep -v homology_id > 10090_10116.homology_ids

echo "select hm1.homology_id from homology_member hm1,homology_member hm2,member m1,member m2 where hm1.homology_id=hm2.homology_id and hm1.member_id=m1.member_id and hm2.member_id=m2.member_id and m1.taxon_id=6239 and m2.taxon_id=6238;"|grep -v homology_id > 6239_6238.homology_ids


To calculate the dN, dS we use ensembl-compara/scripts/homology/generate_dN_dS.pl. The script uses a Compara.conf
to determine where are the needed core database and connect to them. So let's say the Compara.conf specifies
the location of 5 core dbs which at this stage should (may) be all on the production staging MySQL node, ecs2d.
If we send 40 jobs running generate_dN_dS.pl, that means we are creating 40x5 connections, 200. We can go up to
400 connections without much trouble. Obviously that do not take in account that ecs2d might be used by other 
for heavy connections...

check how many homology_ids, we have

cat *.homology_id|wc -l
     71704

So to have ~40 jobs, we can to submit roughly 1800 at once. (71704/40 = 1792.6)

cd homology_ids_in
cat ../*.homology_id|split -l 1800 -a 3 - homology_ids.
ls |cat -n|sed "s/\./ /"|while read i j k;do mv $j.$k $j.$i;done

submit the one job

echo '/nfs/acari/abel/src/ensembl_main/ensembl-compara/scripts/homology/generate_dN_dS.pl -host ecs2e -dbname ensembl_compara_20_1 -conf_file /ecs2/work4/compara_abel_cara/genepair/Compara.conf -id_file homology_ids.${LSB_JOBINDEX} -dir /ecs2/work4/compara_abel_cara/genepair/dNdS/19_2/homology_ids_dNdS'|bsub -JdNdS"[1]" -o ../homology_ids_out/homology_ids.%I.out

If it is working fine send the others

[...] -JdNdS"[2-40]" [...]

check the output files in ../homology_ids_out to see whether all jobs finished well. 

Load dNdS in compara. No proper script for that yet...:(

cd ../homology_ids_dNdS

The data ouput looks like that

head -2 homology_ids.1.codeml
81435 PIP ENSMUSP00000053262    ENSRNOP00000031446      652.9   262.1   0.06185 0.18269 0.33854 -1558.224
81436 SEED ENSMUSP00000040232   ENSRNOP00000015933      1048.2  301.8   0.01938 0.13382 0.14485 -1979.575

homology_id type stable_id stable_id N S dN dS dN/dS LnL

we are just interested by homology_id, dN and dS

cat *.codeml|awk '{print "update homology set dn="$7",ds="$8",n="$5",s="$6",lnl="$10" where homology_id="$1";"}' > update_dnds.sql

mysql -h ecs2e -u ensadmin -pxxxxxx ensembl_compara_20_1 < update_dnds.sql

Deterining the median cut-off (still need to find a way to store in the compara db, in meta table probably)

mysql> select count(*) from homology where stable_id like "9606_10090%";
+----------+
| count(*) |
+----------+
|    19374 |
+----------+
1 row in set (0.20 sec)

if count is even number the median is the average of (19374/2) 9687th value and the 9688th value

mysql> select ds from homology where stable_id like "9606_10090%" order by ds asc limit 9686,2;
+---------+
| ds      |
+---------+
| 0.62996 |
| 0.63008 |
+---------+
2 rows in set (0.40 sec)

so median is (0.62996+0.63008)/2 = 0.63002

if count id odd number

mysql> select count(*) from homology where stable_id like "9606_10090%";
+----------+
| count(*) |
+----------+
|    19373 |
+----------+
1 row in set (0.20 sec)

Then the median is the ((19373-1)/2) 9686th value

mysql> select ds from homology where stable_id like "9606_10090%" order by ds asc limit 9686,1;
+---------+
| ds      |
+---------+
| 0.62996 |
+---------+
1 row in set (0.45 sec)

For the web display we then apply a cut-off of 2*median. So let's say the median is 0.63002,
the cut-off will be 1.26004 (0.63002*2). So for an homology_id the ds>1.26004 for the paired species
considered, dS and dN values are not considered reliable and not displayed (even though being stored in 
the database)

To set the cut-off in the db,

update homology set threshold_on_ds=1.26004 where stable_id like "9606_10090%";
