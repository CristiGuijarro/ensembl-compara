19th August 2002
----------------

Generating synteny blocks from raw dna-dna matches
--------------------------------------------------

Need dna-dna matches stored in an ensembl compara database or a set of gff files, one per chromosome


2. Configuration
-----------------


2.1 Code needed : 

core, trace and compara core modules

  cvs -d :ext:cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co -r branch-ensembl-12 ensembl ensembl-compara ensembl-trace

bioperl ensembl modules

  cvs -d :ext:bio.perl.org:/home/repository/bioperl co -r ?Tag? bioperl-live

works with branch-07, but should also work with branch-1-2, need a try.

2.2 Set up the perl environment :

  cd ensembl-compara/scripts/synteny
  setenv BASEDIR /some/path/to modules
  setenv PERL5LIB ${BASEDIR}/bioperl-0.7:${BASEDIR}/ensembl/modules:${BASEDIR}/ensembl-compara/modules:${BASEDIR}/ensembl-trace/modules


2.3 Databases needed

  2.3.1 Compara database

    You will need the hostname, database name, username and password to the relevant compara database

  2.3.2 Core database

    You will need the above information for the core database as well as the name of the static golden path.
    This database is used to fetch the names and the lengths of the chromosomes.

	You will need to set up a Compara.conf file, that will hold all necessary information to connect any needed core database. See an example in ensembl-compara/modules/Bio/EnsEMBL/Compara/Compara.conf.example


3. Dumping the raw dna-dna matches
----------------------------------

  3.1. The dumping script


ensembl-compara/scripts/synteny/dumpsynteny

This dumps out dna-dna in gff format one chromosome at a time and the format of the command is

echo "select distinct(name) from dnafrag where genome_db_id=2 and dnafrag_type=\"Chromosome\";"|mysql -h ecs1b -u ensro ensembl_compara_11_1 |awk '!/name/' |sort >Mm3_chr_names

cat Mm3_chr_names |while read i;do bsub -q acari -o $i.out -e $i.err ~/src/ensembl_main/ensembl-compara/scripts/synteny/dumpsynteny -host ecs1b -dbname ensembl_compara_11_1 -chr_names $i -species1 "Mus musculus" -assembly1 MGSC3 -species2 "Rattus norvegicus" -assembly2 RGSC2 -conf_file ~/src/ensembl_main/ensembl-compara/module/Bio/EnsEMBL/Compara/Compara.conf;done

This will write out all the dna-dna matches for human chromosomes against mouse into files called

	1.syten.gff
	2.syten.gff
	etc...


4.0 Making synteny blocks

  4.1  Setting the environment

  For the forseeable future this will be done using the apollo code so your path will need to be set to include a JVM.  On the alphas use the following

  PATH=/usr/opt/java131/bin/:$PATH

  4.2 Running over all chromosomes

ls *.syten.gff|sed "s/\.syten\.gff//"|while read i;do java -classpath ~/src/ensembl_main/ensembl-compara/scripts/synteny/BuildSynteny.jar BuildSynteny $i.syten.gff 100000 100000 > $i.100000.100000.BuildSynteny.out 2> $i.100000.100000.BuildSynteny.err;done

cat *.BuildSynteny.out|grep cluster > Mm3Rn2.100000.100000.BuildSynteny

5- Load in compara db

ensembl-compara/scripts/synteny/LoadComparaDb.pl -host ecs2d -dbuser ecs2dadmin -dbpass xxxx -dbname ensembl_compara_13_1 -conf_file /nfs/acari/abel/src/ensembl_main/ensembl-compara/modules/Bio/EnsEMBL/Compara/Compara.conf -genome_db_id1 2 -genome_db_id2 3 Mm3Rn2.100000.100000.BuildSynteny

