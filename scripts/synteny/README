19th August 2002
----------------

Generating synteny blocks from raw dna-dna matches
--------------------------------------------------

Need dna-dna matches stored in an ensembl compara database or a set of gff files, one per chromosome


2. Configuration
-----------------


2.1 Code needed : 

core, trace and compara core modules

  cvs -d :ext:cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co -r branch-ensembl-12 ensembl ensembl-compara ensembl-trace

bioperl ensembl modules

  cvs -d :ext:bio.perl.org:/home/repository/bioperl co -r ?Tag? bioperl-live

works with branch-07, but should also work with branch-1-2, need a try.

2.2 Set up the perl environment :

  cd ensembl-compara/scripts/synteny
  setenv BASEDIR /some/path/to modules
  setenv PERL5LIB ${BASEDIR}/bioperl-0.7:${BASEDIR}/ensembl/modules:${BASEDIR}/ensembl-compara/modules:${BASEDIR}/ensembl-trace/modules


2.3 Databases needed

  2.3.1 Compara database

    You will need the hostname, database name, username and password to the relevant compara database

  2.3.2 Core database

    You will need the above information for the core database as well as the name of the static golden path.
    This database is used to fetch the names and the lengths of the chromosomes.

	You will need to set up a Compara.conf file, that will hold all necessary information to connect any needed core database. See an example in ensembl-compara/modules/Bio/EnsEMBL/Compara/Compara.conf.example


3. Dumping the raw dna-dna matches
----------------------------------

  3.1. The dumping script (Example only - don't run anything yet).


ensembl-compara/scripts/synteny/dumpsynteny

This dumps out dna-dna in gff format one chromosome at a time and the format of the command is

echo "select distinct(name) from dnafrag where genome_db_id=2 and dnafrag_type=\"Chromosome\";"|mysql -h ecs1b -u ensro ensembl_compara_11_1 |awk '!/name/' |sort >Mm3_chr_names

cat Mm3_chr_names |while read i;do bsub -q acari -o $i.out -e $i.err ~/src/ensembl_main/ensembl-compara/scripts/synteny/dumpsynteny -host ecs1b -dbname ensembl_compara_11_1 -chr_names $i -species1 "Mus musculus" -assembly1 MGSC3 -species2 "Rattus norvegicus" -assembly2 RGSC2 -conf_file ~/src/ensembl_main/ensembl-compara/scripts/PhusionBlast/Compara.conf;done

This will write out all the dna-dna matches for human chromosomes against mouse into files called

	1.synteny.gff
	2.synteny.gff
	etc...


4.0 Making synteny blocks

  4.1  Setting the environment

  For the forseeable future this will be done using the apollo code so your path will need to be set to include a JVM.  On the alphas use the following

  PATH=/usr/opt/java131/bin/:$PATH
  CLASSPATH=ensembl-compara/scripts/synteny/apollo.jar; export CLASSPATH
  APOLLO_ROOT=ensembl-compara/scripts/synteny; export APOLLO_ROOT

  4.2 Running over all chromosomes

touch t.gff

cat Hs31_chr_names|while read i;do bsub -q acari -Ralpha -o $i.bsub.out -e $i.bsub.err ~/src/ensembl_main/ensembl-compara/scripts/synteny/makesyntenyblocks -host ecs1b -dbname ensembl_compara_11_1 -species "Homo sapiens" -assembly NCBI31 -chr_names $i -syntenyfile $i.syten.gff -conf_file ~/src/ensembl_main/ensembl-compara/scripts/PhusionBlast/Compara.conf;done

This will generate two sets of files.  
	1) The output from the program in <chr>.100000.syn.out
	2) The synteny block gff in <chr>.100000.gff


5- Load in compara db

echo "select d.name,d.dnafrag_id from dnafrag d,genome_db g where d.genome_db_id=g.genome_db_id and g.name=\"Caenorhabditis elegans\" and d.dnafrag_type=\"Chromosome\" group by d.name;" |mysql -h ecs1b -u ensro ensembl_compara_11_1|awk '!/name/' > Ce95_chr_names

echo "select d.name,d.dnafrag_id from dnafrag d,genome_db g where d.genome_db_id=g.genome_db_id and g.name=\"Caenorhabditis briggsae\" and d.dnafrag_type=\"Chromosome\" group by d.name;" |mysql -h ecs1b -u ensro ensembl_compara_11_1|awk '!/name/' > Cb25_chr_names

check what in the max synteny_region_id in the compara_db
ugly but works, that would need a proper script

cat *.100000.gff|awk '{print $1,$4,$5,$9,$10,$11,$7}'|sort|join Ce95_chr_names -|awk '{print $5,$6,$7,$2,$3,$4,$8}'|sort |join Cb25_chr_names -|awk '{print $5,$6,$7,$2,$3,$4,$8}'|awk 'BEGIN {synteny_region_id=1} {print "insert into synteny_region values ("synteny_region_id","$7");";print "insert into dnafrag_region values ("synteny_region_id","$1","$2","$3");";print "insert into dnafrag_region values ("synteny_region_id","$4","$5","$6");";synteny_region_id++}' > synteny.sql

mysql -h ecs1b -u ensadmin -pensembl ensembl_compara_11_1_test < synteny.sql