
For now, the genetree process is an add-on to the homology pipeline.
Please start reading README-homology first.

# 1- Load the NCBI taxonomy data 
#    ~~~~~~~~~~~~~~~~~~~~~~~~~~~
# These instructions are in the README-homology file as of ensembl v40
# 
# Ideally this should be a job by itself in the pipeline but for now,
# it's done by hand :)
#
# All instructions to do it are in
# ensembl-compara/scripts/taxonomy/README-taxonomy


# 2- Create the other gene tree-related tables in the database
#   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# These tables are already in the main ensembl-compara/sql/table.sql
# file as of ensembl v40.
#
# $ mysql -hcompara1 -uensadmin -pensembl abel_compara_tree_41 \
#   < ensembl-compara/sql/protein_tree.sql
#
# This will create 3 tables
# protein_tree_node
# protein_tree_member
# protein_tree_tag


3- Copy and modify the compara-hive config file
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You may need to change the database names, port, dbnames, and the
paths to the 'hive_output_dir' and 'fasta_dir'. Note that these dirs
must exist.

  $ cd $BASEDIR/ensembl-compara/scripts/pipeline
  $ cp compara-hive-homology.conf.example my_compara.conf
  <editor> my_compara.conf

 { TYPE => GENE_TREE,
    'cluster_params' => 
        '{'
        .'species_set=>[3,4,5,7,10,11,13,14,15,16,17,18,22,24,25,26,27,28,29,31,32,33,34,35,36],'
        .'brh=>1,'
        .'all_best=>0,'
        .'bsr_threshold=>0.33'
        .'}',
     'breakcluster_params' => 
        '{'
        .'species_set=>[3,4,5,7,10,11,13,14,15,16,17,18,22,24,25,26,27,28,29,31,32,33,34,35,36],'
        .'bsr_threshold_increase=>0.1'
        .'}',
    'max_gene_count' => 2000,
    'species_tree_file' => 
        '{'
        .'species_tree_file=>'
                .'"/ecs2/work2/avilella/hive/avilella_compara_homology_40/'
                .'compara_encode_species_tree_40_mfurc.nh"'
        .'}',
    'rap_jar_file' => '/ecs2/work2/avilella/bin/rap.jar'
  },

One example of the species_tree_file can be found in
ensembl-compara/scripts/pipeline/species_tree.rap


4- Create the species tree file 
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A NCBI taxon_id phylogenetic tree file representing the species in the
compara DB is required for the njtree stage. The file must be in Nexus
(.nh) format. If you are running the pipeline for your own set of
species, you can generate such a tree with the script
ensembl-compara/scripts/tree/testTaxonTree.pl.

To have your list of NCBI taxon_ids, you can use "-query_ncbi_name"
like this:

/usr/local/ensembl/bin/perl \
~/src/ensembl_main/ensembl-compara/scripts/tree/testTaxonTree.pl \
-url mysql://ensro@ens-staging/ensembl_compara_45 \
-query_ncbi_name "Anopheles gambiae"

NJTREE can distinguish between species that are supposed to have all
the genes represented in the DB and "incomplete" species, that may
have only a part of the genes represented. For the latter, NJTREE
won't try to estimate gene losses given this info.

If you have a DB with say 3 completely sequenced species, Anopheles
gambiae, Aedes aegypti and Drosophila melanogaster, and 2 incomplete
species, Pediculus humanus and Culex pipiens, you can create the
species tree like this:

(a) Look for the NCBI taxon_ids:

testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 -query_ncbi_name "Anopheles gambiae"
testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 -query_ncbi_name "Aedes aegypti"
testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 -query_ncbi_name "Drosophila melanogaster"
testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 -query_ncbi_name "Culex pipiens"
testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 -query_ncbi_name "Pediculus humanus"

the first three then being "-extrataxon_sequenced 7165_7159_7227", 
and the last two being: "-extrataxon_incomplete 7175_121225"

(b) Then you call the script like this:

testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 \
-create_species_tree -extrataxon_sequenced 7165_7159_7227 \
-extrataxon_incomplete 7175_121225  -no_previous

Which in this case will create your file with the name "njtree.5.ensembl_compara_45.nh":

((((7175,7159*)53550,7165*)7157,7227*)7147,121225);

Also, there is an option to ignore internal nodes present in the NCBI
taxonomy. This will multifurcate the tree at the point when the given
node would disappear. For example, if one wants to ignore the
Coelomata (33316) internal node, and create a multifurcation at that
point, the option would be "-multifurcation_deletes_node 33316".

If you want to create a species_tree with all the species already
present in a previous Compara DB plus a few new species, you can use
the script connecting to that given DB and without the "-no_previous"
option. For example:

testTaxonTree.pl -url mysql://ensro@ens-staging/ensembl_compara_45 \
-create_species_tree -extrataxon_sequenced 9823 \
-multifurcation_deletes_node 33316

will create a tree with the species in ensembl_compara_45, deleting
the Coelomata internal node and adding the Sus scrofa species as
completely sequenced.


  Old RAP method (not needed anymore with NJTREE)
  ==============================================

An annotated phylogenetic tree file representing the species in the
compara DB and their relative distances is required for the final rap
tree building stage. The file must be in Nexus (.nh) format, with all
levels enclosed with a '()ROOT:0.0;' level. A curated nh file
containing the ensembl species is available at
ensembl_compara/scripts/pipeline/species_tree.rap

An unweighted file based on the NCBI taxonomy can be generated using
compara's taxonTreeTool.pl as follows;

 $ $BASEDIR/ensembl-compara/scripts/taxonomy/taxonTreeTool.pl \
   -url mysql://ensro@compara1:3306/abel_compara_tree_41 \
   -taxa_compara -mini \
   | tail n 1

The file that is to be used for rap should be configured in the
'species_tree_file' setting of my_compara.GENE_TREE.



5- Run the configure scripts
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The loadGeneTreeSystem script creates the analysis entries for the
processing system, and creates both the dataflow rule and the analysis
control rules.  It also initializes the analysis_stats row for each
analysis.  These rows hold information like batch_size, hive_capacity,
and run-time stats that the Hive's Queen will update.

These scripts may give you warnings if the output directories are not
available or if it's unable to connect to core databases.

 $ cd $BASEDIR/ensembl-compara/scripts/pipeline
 $ ./loadGeneTreeSystem.pl -conf my_compara.conf

At this point the system is ready to run using the beekeeper.pl script
as explained in the README-homology
