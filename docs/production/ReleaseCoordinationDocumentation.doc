Message-ID: <326156003.28873.1534925491388.JavaMail.crs_adm@0711f511f1d3>
Subject: Exported From Confluence
MIME-Version: 1.0
Content-Type: multipart/related; 
	boundary="----=_Part_28872_1986318149.1534925491387"

------=_Part_28872_1986318149.1534925491387
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Content-Location: file:///C:/exported.html

<html xmlns:o=3D'urn:schemas-microsoft-com:office:office'
      xmlns:w=3D'urn:schemas-microsoft-com:office:word'
      xmlns:v=3D'urn:schemas-microsoft-com:vml'
      xmlns=3D'urn:w3-org-ns:HTML'>
<head>
    <meta http-equiv=3D"Content-Type" content=3D"text/html; charset=3Dutf-8=
">
    <title>Release coordination documentation</title>
    <!--[if gte mso 9]>
    <xml>
        <o:OfficeDocumentSettings>
            <o:TargetScreenSize>1024x640</o:TargetScreenSize>
            <o:PixelsPerInch>72</o:PixelsPerInch>
            <o:AllowPNG/>
        </o:OfficeDocumentSettings>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotOptimizeForBrowser/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
                <!--
        @page Section1 {
            size: 8.5in 11.0in;
            margin: 1.0in;
            mso-header-margin: .5in;
            mso-footer-margin: .5in;
            mso-paper-source: 0;
        }

        table {
            border: solid 1px;
            border-collapse: collapse;
        }

        table td, table th {
            border: solid 1px;
            padding: 5px;
        }

        td {
            page-break-inside: avoid;
        }

        tr {
            page-break-after: avoid;
        }

        div.Section1 {
            page: Section1;
        }

        /* Confluence print stylesheet. Common to all themes for print medi=
a */
/* Full of !important until we improve batching for print CSS */

@media print {
    #main {
        padding-bottom: 1em !important; /* The default padding of 6em is to=
o much for printouts */
    }

    body {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        font-size: 10pt;
        line-height: 1.2;
    }

    body, #full-height-container, #main, #page, #content, .has-personal-sid=
ebar #content {
        background: #fff !important;
        color: #000 !important;
        border: 0 !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
    }

    a, a:link, a:visited, a:focus, a:hover, a:active {
        color: #000;
    }

    #content h1,
    #content h2,
    #content h3,
    #content h4,
    #content h5,
    #content h6 {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        page-break-after: avoid;
    }

    pre {
        font-family: Monaco, "Courier New", monospace;
    }

    #header,
    .aui-header-inner,
    #navigation,
    #sidebar,
    .sidebar,
    #personal-info-sidebar,
    .ia-fixed-sidebar,
    .page-actions,
    .navmenu,
    .ajs-menu-bar,
    .noprint,
    .inline-control-link,
    .inline-control-link a,
    a.show-labels-editor,
    .global-comment-actions,
    .comment-actions,
    .quick-comment-container,
    #addcomment {
        display: none !important;
    }

    /* CONF-28544 cannot print multiple pages in IE */
    #splitter-content {
        position: relative !important;
    }

    .comment .date::before {
        content: none !important; /* remove middot for print view */
    }

    h1.pagetitle img {
        height: auto;
        width: auto;
    }

    .print-only {
        display: block;
    }

    #footer {
        position: relative !important; /* CONF-17506 Place the footer at en=
d of the content */
        margin: 0;
        padding: 0;
        background: none;
        clear: both;
    }

    #poweredby {
        border-top: none;
        background: none;
    }

    #poweredby li.print-only {
        display: list-item;
        font-style: italic;
    }

    #poweredby li.noprint {
        display: none;
    }

    /* no width controls in print */
    .wiki-content .table-wrap,
    .wiki-content p,
    .panel .codeContent,
    .panel .codeContent pre,
    .image-wrap {
        overflow: visible !important;
    }

    /* TODO - should this work? */
    #children-section,
    #comments-section .comment,
    #comments-section .comment .comment-body,
    #comments-section .comment .comment-content,
    #comments-section .comment p {
        page-break-inside: avoid;
    }

    #page-children a {
        text-decoration: none;
    }

    /**
     hide twixies

     the specificity here is a hack because print styles
     are getting loaded before the base styles. */
    #comments-section.pageSection .section-header,
    #comments-section.pageSection .section-title,
    #children-section.pageSection .section-header,
    #children-section.pageSection .section-title,
    .children-show-hide {
        padding-left: 0;
        margin-left: 0;
    }

    .children-show-hide.icon {
        display: none;
    }

    /* personal sidebar */
    .has-personal-sidebar #content {
        margin-right: 0px;
    }

    .has-personal-sidebar #content .pageSection {
        margin-right: 0px;
    }

    .no-print, .no-print * {
        display: none !important;
    }
}
-->
    </style>
</head>
<body>
    <h1>Release coordination documentation</h1>
    <div class=3D"Section1">
        <p><style type=3D"text/css">/*<![CDATA[*/
div.rbtoc1534925490710 {padding: 0px;}
div.rbtoc1534925490710 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1534925490710 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p>
<div class=3D"toc-macro rbtoc1534925490710">=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Preparation">Preparation</=
a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Preparingthisdocumentitsel=
f">Preparing&nbsp;this document itself</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-DeclarationofIntentions">D=
eclaration of Intentions</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Updateyourcheckouts">Updat=
e your&nbsp;checkouts</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Environmentvariables">Envi=
ronment variables</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-PreparingJIRAtickets">Prep=
aring JIRA tickets</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Comparaservers">Compara se=
rvers</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Configurationfile">Configu=
ration file</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Schemapreparation">Schema =
preparation</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Updatetable.sqlandcreatepa=
tchfiles">Update table.sql and create patch files</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Checkthepatchfiles">Check =
the patch files</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Patchthereuseddatabasestot=
helatestschema">Patch the reused databases to the latest schema</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Patchthetestdatabases">Pat=
ch the test databases</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Branchthecode">Branch the =
code</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Specializethebranch">Speci=
alize the branch</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Masterdatabase">Master dat=
abase</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-NCBItaxonomydata">NCBI tax=
onomy data</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Addnewentriestocomparamast=
erdatabase">Add new entries to compara master database</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Addmethod_link_species_set=
entriestocomparamasterdatabase">Add method_link_species_set entries to comp=
ara master database</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Finaleditstocomparamasterd=
atabase">Final edits to compara master database</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Production">Production</a>=
=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Pre-productiontasks">Pre-p=
roduction tasks</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Coredatabases">Core databa=
ses</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Linuxbrewpaths">Linuxbrew =
paths</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Mainsite">Main site</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-LastZs">LastZs</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Members">Members</a></li>=
=20
<li><a href=3D"#Releasecoordinationdocumentation-Genomedumps">Genome dumps<=
/a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Species-tree">Species-tree=
</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-GRCh37site">GRCh37 site</a=
></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Endofproductionwindow">End=
 of production window</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-CreateReleaseDatabase">Cre=
ate Release Database</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Theremovalofolddatashouldn=
'tbenecessaryunlesstheskip_mlssentriesarenotuptodate.Howeverifyouneedtoremo=
veolddatafromthereleasedbfollowtheinstructionsbelow">The removal of old dat=
a shouldn't be necessary unless the skip_mlss entries are not up to date. H=
owever if you need to remove old data from the release db follow the instru=
ctions below</a></li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-MergeDNAdata">Merge DNA da=
ta</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Mergethehomologypipelines"=
>Merge the homology pipelines</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Finaldatabasechecks">Final=
 database checks</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Runthehealthchecks">Run th=
e healthchecks</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Testwebserver">Test web se=
rver</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Finalhandoverofdatabases[e=
dit]">Final handover of databases [edit]</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Handover">Handover</a></li=
>=20
<li><a href=3D"#Releasecoordinationdocumentation-Finalbits">Final bits</a><=
/li>=20
</ul> </li>=20
</ul> </li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Post-handover">Post-handov=
er</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-Updatedocumentationanddiag=
rams[edit]">Update documentation and diagrams [edit]</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Testthesites">Test the sit=
es</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-Datadumps">Data dumps</a>=
=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Releasecoordinationdocumentation-SpeciesTrees">Species Tree=
s</a></li>=20
<li><a href=3D"#Releasecoordinationdocumentation-TreeFamHMMs">TreeFam HMMs<=
/a></li>=20
</ul> </li>=20
</ul> </li>=20
</ul>=20
</div>
<p></p>
<h1 id=3D"Releasecoordinationdocumentation-Preparation">Preparation</h1>
<h2 id=3D"Releasecoordinationdocumentation-Preparingthisdocumentitself">Pre=
paring&nbsp;<strong>this</strong> document itself</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"608">This document is usually =
inherited from the previous release cycle and tends to have all the check-b=
oxes ticked. The fastest way to untick them all to start afresh is to go to=
 "Edit...", then switch over to the XML view (a button on the top right wit=
h &lt;&gt; on it), and then perform a mass-replace of&nbsp;<code>&lt;ac:tas=
k-status&gt;complete&lt;/ac:task-status&gt;</code> by&nbsp;<code>&lt;ac:tas=
k-status&gt;incomplete&lt;/ac:task-status&gt;</code></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-DeclarationofIntentions">Declara=
tion of Intentions</h2>
<p>Intentions for the upcoming releases are discussed at the Compara group =
meetings, and then approved at the Ensembl Operations meetings. They can be=
 consulted online at (https://www.ebi.ac.uk/seqdb/confluence/display/EnsCom=
/Intentions+for+release+XX)</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"4"><p>At the beginning the rel=
ease cycle, the release coordinator sets up a web page with intentions in t=
he Confluence wiki system to allow easy tracking of the progress. <a href=
=3D"/seqdb/confluence/display/EnsCom/Release+plans">Release plans</a> &gt; =
Click on the three dots at the tip next to the "Create" button , and select=
 the <em>Intentions for Release</em> template.<br>The JIRA board for the re=
lease can be found by following the link to the correct release number on <=
a href=3D"https://www.ebi.ac.uk/panda/jira/projects/ENSCOMPARASW?selectedIt=
em=3Dcom.atlassian.jira.jira-projects-plugin:release-page" class=3D"externa=
l-link" rel=3D"nofollow">https://www.ebi.ac.uk/panda/jira/projects/ENSCOMPA=
RASW?selectedItem=3Dcom.atlassian.jira.jira-projects-plugin:release-page<br=
>Generat</a>e the image of the dependency graph with this command:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">/usr/bi=
n/dot -Tpng &lt; $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/com=
para_ensembl.dot &gt; $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipelin=
e/compara_ensembl.png</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Do not commit the .png file. If the dependencies have changed, update an=
d commit th .dot file, and upload a new version of the image to the Intenti=
ons page</p>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Updateyourcheckouts">Update your=
&nbsp;checkouts</h2>
<p>Ensure you have up-to-date git checkouts of at least the following repos=
itories, pointing at master branch:</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"35">ensembl-compara</li>
<li class=3D"checked" data-inline-task-id=3D"36">ensembl</li>
<li class=3D"checked" data-inline-task-id=3D"37">ensembl-hive</li>
<li class=3D"checked" data-inline-task-id=3D"38">ensembl-analysis</li>
<li class=3D"checked" data-inline-task-id=3D"39">ensj-healthcheck</li>
<li class=3D"checked" data-inline-task-id=3D"543">ensembl-taxonomy</li>
<li class=3D"checked" data-inline-task-id=3D"547">public-plugins</li>
<li class=3D"checked" data-inline-task-id=3D"578">ensembl-test</li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Environmentvariables">Environmen=
t variables</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"9"><p>Define <code>$ENSEMBL_CV=
S_ROOT_DIR</code> <br>This is necessary to run the Hive and is used by many=
 scripts/files in this document. Make sure this is defined in your terminal=
</p></li>
<li class=3D"checked" data-inline-task-id=3D"10"><p>Define <code>$ENSADMIN_=
PSW</code> <br>The password for the mysql 'ensadmin' user also needed for m=
any scripts</p></li>
<li class=3D"checked" data-inline-task-id=3D"511"><p>Define <code>$COMPARA_=
REG</code> variable to simplify connecting to databases via registry</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">export =
COMPARA_REG=3D"-reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipe=
line/production_reg_ebi_conf.pl -reg_type compara -reg_alias"</pre>=20
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"513"><p>Define <code>$CURR_ENS=
EMBL_RELEASE</code> variable to simplify naming of databases</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">export =
CURR_ENSEMBL_RELEASE=3D`perl -mBio::EnsEMBL::ApiVersion -e 'print Bio::EnsE=
MBL::ApiVersion::software_version()."\n"'`
&nbsp;
=09#&nbsp;make sure that you got the right value (your ensembl checkout has=
 to be up-to-date)
echo $CURR_ENSEMBL_RELEASE
&nbsp;
=09# it is also very handy to have the previous release number in a variabl=
e:
export PREV_ENSEMBL_RELEASE=3D`expr $CURR_ENSEMBL_RELEASE - 1`</pre>=20
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"600"><p>source the RH7 env</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">source =
/nfs/software/ensembl/latest/envs/basic.sh</pre>=20
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"601"><p>Make sure you are usin=
g the production queue (as everyone in the team should !)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">export =
LSB_DEFAULTQUEUE=3Dproduction-rh7</pre>=20
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"634"><p>Backup the master data=
base</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">mysql-e=
ns-compara-prod-1 mysqldump ensembl_compara_master &gt; /nfs/production/pan=
da/ensembl/warehouse/compara/master_db_dumps/ensembl_compara_master.$(date =
'+%Y%m%d').pre${CURR_ENSEMBL_RELEASE}.sql</pre>=20
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-PreparingJIRAtickets">Preparing =
JIRA tickets</h2>
<p>As of release 89, JIRA ticket creation for the release process is perfor=
med automatically using a script.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"606"><p>The script assumes tha=
t the relco is running it, but you can use the <code>-relco</code> option t=
o override the user name.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Automatically create JIRA tickets</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensembl-compara/scripts/jira_tickets
perl create_compara_release_JIRA_tickets.pl</pre>=20
</div>
</div><p>The script will print the paths of the configuration files it's re=
ad, and the release number it's targeting (taken from the Core API), and th=
en ask for your JIRA password</p>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
Only run this script once the list of tickets has been updated based on las=
t release's run ! (look for a ticket named "
<em>Update the Jira_recurrent_tickets.txt</em>")
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Comparaservers">Compara servers<=
/h2>
<p>Check out the current space on the compara servers and delete the last b=
ut one release. <span>Leave the previous release for healthchecks.</span> <=
span>&nbsp;</span>Check with the other compara team members before deleting=
.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"596"><p>Check space <a href=3D=
"http://www.ebi.ac.uk/~muffato/disk/compara.html" class=3D"external-link" r=
el=3D"nofollow">on </a> <a href=3D"http://www.ebi.ac.uk/~muffato/disk/compa=
ra.html" class=3D"external-link" rel=3D"nofollow">http://www.ebi.ac.uk/~muf=
fato/disk/compara.html</a> <br>You can click on "Show per-database disk usa=
ge" to see the list of databases and their size</p>
<div id=3D"expander-1973954962" class=3D"expand-container">
<div id=3D"expander-control-1973954962" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for the guidelines for the d=
eletion of databases...</span>
</div>
<div id=3D"expander-content-1973954962" class=3D"expand-content">
<ul>
<li>Research databases should be fully backed up</li>
<li>Release databases: keep only the last one (for HCs)</li>
<li><p>Production databases: keep the last production run of each pipeline =
on each species-set, e.g. keep the primate EPO <strong>and</strong> the mam=
mal EPO <strong>and</strong> etc<br>Before dropping any of the databases, b=
ack up the eHive tables</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">standal=
oneJob.pl Bio::EnsEMBL::Hive::RunnableDB::DatabaseDumper -exclude_list 1 -d=
b_conn $URL -debug 9 -output_file path/to/file.sql.gz</pre>=20
</div>
</div></li>
</ul>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Configurationfile">Configuration=
 file</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"528"><p>Update <code>productio=
n_reg_ebi_conf.pl</code> and check back into git:</p>
<div id=3D"expander-1449563108" class=3D"expand-container">
<div id=3D"expander-control-1449563108" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click for details</span>
</div>
<div id=3D"expander-content-1449563108" class=3D"expand-content">
<ul>
<li>Update the registry configuration file <code>$ENSEMBL_CVS_ROOT_DIR/ense=
mbl-compara/scripts/pipeline/production_reg_ebi_conf.pl</code> that will be=
 used throughout the release process.</li>
<li>Make sure to have edited the release numbers, added external core datab=
ases and fixed name prefixes.</li>
<li>The convention is to keep the merged release database on mysql-ens-comp=
ara-prod-1.</li>
<li>DB connection details of production databases (families, nctrees, etc.)=
 can be removed from the file until merge.</li>
</ul>
</div>
</div></li>
</ul>
<h1 id=3D"Releasecoordinationdocumentation-Schemapreparation">Schema prepar=
ation</h1>
<div class=3D"confluence-information-macro confluence-information-macro-inf=
ormation">
<span class=3D"aui-icon aui-icon-small aui-iconfont-info confluence-informa=
tion-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>All the schema changes must be ready by the handover of the core databas=
es. See <a href=3D"/seqdb/confluence/pages/viewpage.action?pageId=3D2974985=
8">SOP for API / schema changes</a> for the procedure about changing the sc=
hema</p>
</div>
</div>
<h2 id=3D"Releasecoordinationdocumentation-Updatetable.sqlandcreatepatchfil=
es">Update table.sql and create patch files</h2>
<p>Here we need to prepare table.sql for the new schema and create the rele=
vant patch files. The general procedure is defined in <a href=3D"/seqdb/con=
fluence/pages/viewpage.action?pageId=3D29749858">SOP for API / schema chang=
es</a>.</p>
<p>The other Compara members may have already created patches, so check wit=
h them what's there. At the minimum, there should be the schema version inc=
rease.</p>
<div id=3D"expander-1326862815" class=3D"expand-container">
<div id=3D"expander-control-1326862815" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1326862815" class=3D"expand-content">
<p>Update the <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/sql/table.sql</co=
de> file and create any patch files.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"51">Create a patch file for th=
e schema_version</li>
<li class=3D"checked" data-inline-task-id=3D"67">Update the schema_version =
in table.sql and delete the other patch INSERT statements</li>
<li class=3D"checked" data-inline-task-id=3D"52">Check if any other patch f=
iles need creating by looking at the Declaration of Intentions and checking=
 with other compara team members</li>
<li class=3D"checked" data-inline-task-id=3D"486">Add an INSERT statement f=
or the new schema_version in table.sql and for any other new patches</li>
<li class=3D"checked" data-inline-task-id=3D"594">Check that all the INSERT=
 statements in table.sql are correct (version numbers and letters) and matc=
h the patches</li>
</ul>
</div>
</div>
<h2 id=3D"Releasecoordinationdocumentation-Checkthepatchfiles">Check the pa=
tch files</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"558"><p>The schema defined in =
the current table.sql must be obtainable by patching the previous database.=
 There is a shell script to do the comparison:</p>
<div id=3D"expander-2030181377" class=3D"expand-container">
<div id=3D"expander-control-2030181377" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-2030181377" class=3D"expand-content">
<p>Run the script <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/produ=
ction/schema_diff.sh</code> (you may have to press "y" to validate the patc=
hes to apply to the old schema) and check the output. The script relies on =
several things:</p>
<ul>
<li>The API version declared by the Core API (in Bio::EnsEMBL::ApiVersion) =
has been updated</li>
<li>The meta keys in the live database are correct (they should !)</li>
</ul>
<p>The only allowed difference is that peptide_align_feature_XX tables are =
only found in the previous database, not the new one. The script writes 3 f=
iles to the current directory: old_schema.sql, patched_old_schema.sql, and =
new_schema.sql, and automatically runs sdiff. If you need to look at the di=
ff later on, run this:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">sdiff -=
w 200 -bs patched_old_schema.sql new_schema.sql </pre>=20
</div>
</div>
<p>git commit table.sql and any patch files</p>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Patchthereuseddatabasestothelate=
stschema">Patch the reused databases to the latest schema</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"613"><p>Use the following scri=
pt to detect the what schema the database is on and to apply all the requir=
ed patches to bring it to the latest schema (double-check the database name=
s !)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl/misc-scripts/schema_patcher.pl $(mysql-ens-compara-p=
rod-1-ensadmin details script) --database=3Densembl_compara_${PREV_ENSEMBL_=
RELEASE}
$ENSEMBL_CVS_ROOT_DIR/ensembl/misc-scripts/schema_patcher.pl $(mysql-ens-co=
mpara-prod-1-ensadmin details script) --database=3Densembl_ancestral_${PREV=
_ENSEMBL_RELEASE}
</pre>=20
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Patchthetestdatabases">Patch the=
 test databases</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"525"><p>Be sure you are on a f=
resh master and follow the instructions from <a href=3D"/seqdb/confluence/d=
isplay/ENSCORE/Patching+test+databases">Patching test databases</a> <br>Che=
ck that all the databases have been patched with</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">grep "s=
chema_version." modules/t/test-genome-DBs/*/*/meta.txt</pre>=20
</div>
</div><p>Rerun the entire test-suite to check that it still passes (fix it =
otherwise !)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">prove -=
rv modules/t/</pre>=20
</div>
</div><p>Commit and push all the changes under modules/t/test-genome-DBs/<s=
pan>&nbsp;</span></p></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Branchthecode">Branch the code</=
h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"549"><p>Check with the rest of=
 Compara that it is ok to branch the code as it is, then create the 'releas=
e/THIS_RELEASE_NUMBER' branch in git and push it to the server.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensembl-compara
git pull master
git branch release/$CURR_ENSEMBL_RELEASE
git checkout release/$CURR_ENSEMBL_RELEASE
git push origin release/$CURR_ENSEMBL_RELEASE</pre>=20
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Specializethebranch">Specialize =
the branch</h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"551"><p>The name of the branch=
 ("master") is hardcoded in a number of places. Because the release branch =
is meant to be coupled to the other release branches, replace "master" with=
 "release/&lt;release number&gt;" in these places</p>
<ul>
<li>README.md</li>
<li><p>.travis.yml . For all the repos that are eventually branched (ensemb=
l-XXX, except ensembl-hive, and the external dependencies) we want to switc=
h over to release/XX, but since they may not yet be branched, we also need =
to add a fallback to master, e.g.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence"># repla=
ce 'git clone --branch master --depth 1 https://github.com/Ensembl/ensembl-=
rest.git' with:
git clone --branch release/89 --depth 1 https://github.com/Ensembl/ensembl-=
rest.git || git clone --branch master --depth 1 https://github.com/Ensembl/=
ensembl-rest.git</pre>=20
</div>
</div><p>Take a look at .travis.yml on the release/89 branch for an example=
</p></li>
</ul><p>However on master, we want to stick to the master branch of all dep=
endencies, so here are the commands to update the files on the release/XX b=
ranch only without affecting master</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensembl-compara
git checkout release/$CURR_ENSEMBL_RELEASE
(edit and commit the files as explained above)
git push origin release/$CURR_ENSEMBL_RELEASE
git checkout master
git merge -s ours release/$CURR_ENSEMBL_RELEASE
git diff origin/master..master  # should be empty
git push origin master
</pre>=20
</div>
</div><p>Pay attention to the merge command. The "-s ours" option tells git=
 to make a merge commit that doesn't change any files (git diff will confir=
m that). The merge is still important so that bugfixes put on the release b=
ranch can be naturally merged with a standard git merge.</p></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"516">Patch the previous produc=
tion and ancestral databases using the above script</li>
<li class=3D"checked" data-inline-task-id=3D"556">Patch the master database=
<span>&nbsp;(</span> <span style=3D"color: rgb(255,0,0);">run the commands =
contained in the patch files individually, given that some patches may fail=
 due to the master having an incomplete set of tables</span> <span>)</span>=
</li>
</ul>
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>From this point, all the production should happen on the release branch,=
 with bugfixes pushed there. We shouldn't worry about master until the end =
of production</p>
</div>
</div>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"605"><span>Ask Matthieu or a g=
it paladin (#git channel on Slack)</span> to <em>protect</em> the new relea=
se branch. <a href=3D"https://github.com/Ensembl/ensembl-compara/settings/b=
ranches" class=3D"external-link" rel=3D"nofollow">https://github.com/Ensemb=
l/ensembl-compara/settings/branches</a> <br>Only tick "Protect this branch"=
, none of the other tickboxes</li>
<li class=3D"checked" data-inline-task-id=3D"625">Ask Matthieu or<span> a g=
it paladin (#git channel on Slack)</span> to add a daily run of the branch =
on Travis CI <a href=3D"https://travis-ci.org/Ensembl/ensembl-compara/setti=
ngs" class=3D"external-link" rel=3D"nofollow">https://travis-ci.org/Ensembl=
/ensembl-compara/settings</a> (choose "Always Run").<br>Disable the daily r=
uns on branches that are not live any more (usually release n-2)</li>
</ul>
<h1 id=3D"Releasecoordinationdocumentation-Masterdatabase"><span>Master dat=
abase<br> </span></h1>
<div class=3D"confluence-information-macro confluence-information-macro-inf=
ormation">
<span class=3D"aui-icon aui-icon-small aui-iconfont-info confluence-informa=
tion-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>The Master database can be updated at any time but must be ready before =
the main pipelines start. For more information about its role, consult <a h=
ref=3D"/seqdb/confluence/display/EnsCom/Master+database">Master database</a=
>.</p>
</div>
</div>
<h2 id=3D"Releasecoordinationdocumentation-NCBItaxonomydata">NCBI taxonomy =
data</h2>
<p>The production team updates the ncbi_taxonomy database on livemirror jus=
t before the handover to us (please check that this has been done). We then=
 need to update the tables on our master DB. The current (rel.90) master da=
tabase is ensembl_compara_master on mysql-ens-compara-prod-1</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"591"><p>Update the ncbi_taxa_n=
ode and ncbi_taxa_name in the master database</p>
<div id=3D"expander-1826013795" class=3D"expand-container">
<div id=3D"expander-control-1826013795" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1826013795" class=3D"expand-content">
<p>The ncbi_taxonomy database is located in <a rel=3D"nofollow">mysql://ens=
ro@mysql-ensembl-mirror:4240/ncbi_taxonomy</a></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>mysqldump</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time db=
_cmd.pl $COMPARA_REG ncbi_taxonomy -reg_type taxonomy -executable mysqldump=
 --prepend --extended-insert --prepend --compress ncbi_taxa_node ncbi_taxa_=
name | sed 's/ENGINE=3DMyISAM/ENGINE=3DInnoDB/g' | db_cmd.pl $COMPARA_REG c=
ompara_master</pre>=20
</div>
</div>
<p>It usually takes between 30 and 60 seconds.</p>
<p>Then check that all the GenomeDBs still have a valid taxon_id</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_master -sql 'SELECT genome_db.* FROM genome_db LEFT=
 JOIN ncbi_taxa_node USING (taxon_id) WHERE genome_db.taxon_id IS NOT NULL =
AND ncbi_taxa_node.taxon_id IS NULL'</pre>=20
</div>
</div>
<p>Only genome_db_id 76 (tarsius_syrichta/tarSyr1_OLD, the old tarsier) sho=
uld be out of sync, which is fine</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"487"><p>Load ensembl_aliases.s=
ql onto the master database</p>
<div id=3D"expander-393697899" class=3D"expand-container">
<div id=3D"expander-control-393697899" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-393697899" class=3D"expand-content">
<p>The script will report any discrepancies that need to be resolved ie any=
 nodes which have been deleted from the ncbi_taxonomy database but still ha=
ve entries in the ensembl_aliases.sql file.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>load ensembl_aliases</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_master &lt; $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/s=
cripts/taxonomy/ensembl_aliases.sql</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"597"><p>Run the CheckTaxon hea=
lthcheck</p>
<div id=3D"expander-475933584" class=3D"expand-container">
<div id=3D"expander-control-475933584" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-475933584" class=3D"expand-content">
<p>Run the CheckTaxon healthcheck early to find any discrepancies between t=
he ncbi_taxon_name table and the core databases (information about how to s=
et up the healthchecks can be found <a href=3D"http://www.ebi.ac.uk/seqdb/c=
onfluence/display/EnsCom/Release+coordination+documentation#Releasecoordina=
tiondocumentation-Runthehealthchecks" class=3D"external-link" rel=3D"nofoll=
ow">here</a>)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Run healthcheck</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">#cd to =
your local healthcheck git repo :
cd ensj-healthcheck/
&nbsp;
# make sure you are using the right version of JAVA:
export JAVA_HOME=3D/nfs/software/ensembl/latest/linuxbrew/opt/jdk@8
&nbsp;
# if you need to recompile (submit to the farm, because you need more memor=
y than is available on the head) :
bsub -I ant clean jar
&nbsp;
# run the healthchecks (submit to the farm, because you need more memory th=
an is available on the head) :
time bsub -I ./run-configurable-testrunner.sh $(mysql-ens-compara-prod-1 de=
tails script) -d ensembl_compara_master --release $CURR_ENSEMBL_RELEASE -t =
org.ensembl.healthcheck.testcase.compara.CheckTaxon
</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-inf=
ormation">
<p class=3D"title">Taxonomy mismatches</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-info confluence-informa=
tion-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Sometimes, there can be mismatches in the taxonomy between master and th=
e core database. This check lives with compara for historical reasons, but =
in fact, it is more relevant to the production and genebuild teams. Report =
such occurrences to production.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Example mismatch error</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">ensembl=
_compara_master: classification:: Drosophilini Drosophilinae Drosophilidae =
Ephydroidea Acalyptratae Schizophora Cyclorrhapha Eremoneura Muscomorpha Br=
achycera Diptera Holometabola Neoptera Pterygota Dicondylia Insecta Hexapod=
a Pancrustacea Mandibulata Arthropoda Panarthropoda Ecdysozoa Protostomia B=
ilateria Eumetazoa Metazoa Opisthokonta Eukaryota is not in drosophila_mela=
nogaster_core_92_6
drosophila_melanogaster_core_92_6: classification:: Drosophila Drosophiliti=
 Drosophilina Drosophilini Drosophilinae Drosophilidae Ephydroidea Acalyptr=
atae Schizophora Cyclorrhapha Eremoneura Muscomorpha Brachycera Diptera End=
opterygota Neoptera Pterygota Dicondylia Insecta Hexapoda Pancrustacea Mand=
ibulata Arthropoda Panarthropoda Ecdysozoa Protostomia Bilateria Eumetazoa =
Metazoa Opisthokonta Eukaryota is not in ensembl_compara_master</pre>=20
</div>
</div>
</div>
</div>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Addnewentriestocomparamasterdata=
base">Add new entries to compara master database</h2>
<p>The current master database (e90) is called ensembl_compara_master on my=
sql-ens-compara-prod-1. You have to create new genome_dbs and dnafrags when=
 there is a new assembly or a new species. Any new genome_dbs, dnafrags and=
 method_link_species_set_ids need to be added before production starts.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"630"><p>Add the new species / =
assemblies (i.e. genome_dbs)</p>
<div id=3D"expander-9046514" class=3D"expand-container">
<div id=3D"expander-control-9046514" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-9046514" class=3D"expand-content">
<p>Run this to generate a file with the new / updated assemblies</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">mysql-e=
ns-sta-1 ensembl_production_$CURR_ENSEMBL_RELEASE -Ne "SELECT production_na=
me FROM species JOIN db AS db_curr USING (species_id) LEFT JOIN db AS db_pr=
ev ON db_prev.species_id =3D species.species_id AND db_prev.db_release=3Ddb=
_curr.db_release-1 AND db_prev.db_type=3Ddb_curr.db_type WHERE db_curr.db_r=
elease=3D$CURR_ENSEMBL_RELEASE AND db_curr.db_type=3D'core' AND (db_prev.db=
_id IS NULL OR db_prev.db_assembly!=3Ddb_curr.db_assembly) ORDER BY product=
ion_name" &gt; $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/updated_species_names.=
$CURR_ENSEMBL_RELEASE</pre>=20
</div>
</div>
<p>The load all the genomes at once</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/update_genome.pl --reg=
_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg=
_ebi_conf.pl --compara compara_master --release --file $ENSEMBL_CVS_ROOT_DI=
R/ensembl-compara/updated_species_names.$CURR_ENSEMBL_RELEASE</pre>=20
</div>
</div>
<p><strong>in case you ever have to update a single genome </strong></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence"> perl $=
ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/update_genome.pl --re=
g_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_re=
g_ebi_conf.pl --compara compara_master --species Medaka --force --release</=
pre>=20
</div>
</div>
<p><strong> <br> </strong></p>
<p>Add a summary of the new genome_dbs to the confluence page <a href=3D"/s=
eqdb/confluence/display/EnsCom/Release+plans">Release plans</a>. The script=
 may take a while if the species you are adding is new and has a lot of sca=
ffolds. You can check the progress by counting <em>dnafrag</em> entries in =
the master database:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">SELECT C=
OUNT(*) FROM dnafrag;</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"628"><p>Update the collection<=
/p>
<div id=3D"expander-1800247770" class=3D"expand-container">
<div id=3D"expander-control-1800247770" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-1800247770" class=3D"expand-content">
<p>Run this to generate a file with all the current assemblies</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_master -sql 'SELECT name FROM genome_db WHERE first=
_release IS NOT NULL AND last_release IS NULL' -- -BN &gt; $ENSEMBL_CVS_ROO=
T_DIR/ensembl-compara/all_species_names.$CURR_ENSEMBL_RELEASE</pre>=20
</div>
</div>
<p>And then update the collection</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/edit_collection.pl --r=
eg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_r=
eg_ebi_conf.pl --compara compara_master --collection ensembl --file $ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/all_species_names.$CURR_ENSEMBL_RELEASE --up=
date --release</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"560"><p>Add in extra non-refer=
ence patches.</p>
<div id=3D"expander-625388204" class=3D"expand-container">
<div id=3D"expander-control-625388204" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-625388204" class=3D"expand-content">
<p>This is currently done when a new patch for human, mouse or zebrafish&nb=
sp; is released. This may have already been done, please ask !</p>
<p>Details about the patches can be found here <a href=3D"ftp://ftp.ncbi.nl=
m.nih.gov/genbank/genomes/Eukaryotes/vertebrates_mammals/Homo_sapiens/" cla=
ss=3D"external-link" rel=3D"nofollow">ftp://ftp.ncbi.nlm.nih.gov/genbank/ge=
nomes/Eukaryotes/vertebrates_mammals/Homo_sapiens/</a> e.g. for patch 11:&n=
bsp; <a href=3D"ftp://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/verte=
brates_mammals/Homo_sapiens/GRCh37.p11/README" class=3D"external-link" rel=
=3D"nofollow">ftp://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/vertebr=
ates_mammals/Homo_sapiens/GRCh37.p11/README</a></p>
<p>It is first necessary to find if any patches have been deleted or update=
d since alignments on these need to be deleted from the Compara database. T=
his is done by running the find_assembly_patches.pl script on the new and p=
revious release of the core database</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Find assembly patches</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/find_assembly_patches.pl -c=
ompara "mysql://ensro@mysql-ens-compara-prod-1:4485/ensembl_compara_master"=
 -new_core "mysql://ensro@mysql-ens-sta-1:4519/homo_sapiens_core_88_38?grou=
p=3Dcore&amp;species=3Dhomo_sapiens" -prev_core "mysql://ensro@mysql-ensemb=
l-mirror:4240/homo_sapiens_core_87_38?group=3Dcore&amp;species=3Dhomo_sapie=
ns"
&nbsp;</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Sample ouptut</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">NEW pat=
ches
  CHR_HG2088_PATCH 2006369791 2017-01-19 11:45:17
  CHR_HSCHR19KIR_HG2394_CTG3_1 2006369821 2017-01-19 11:45:17
  CHR_HSCHR19KIR_0019-4656-A_CTG3_1 2006369811 2017-01-19 11:45:17
  CHR_HSCHR19KIR_7191059-1_CTG3_1 2006369829 2017-01-19 11:45:17
  CHR_HSCHR19KIR_7191059-2_CTG3_1 2006369835 2017-01-19 11:45:17
  CHR_HSCHR19KIR_0019-4656-B_CTG3_1 2006369831 2017-01-19 11:45:17
  CHR_HSCHRX_3_CTG7 2006369841 2017-01-19 11:45:17
  CHR_HG1708_PATCH 2006369799 2017-01-19 11:45:17
  CHR_HG2236_PATCH 2006369783 2017-01-19 11:45:17
  CHR_HSCHR19KIR_0010-5217-AB_CTG3_1 2006369827 2017-01-19 11:45:17
  CHR_HSCHR17_11_CTG4 2006369809 2017-01-19 11:45:17
  CHR_HSCHR19KIR_CA01-TB01_CTG3_1 2006369819 2017-01-19 11:45:17
  CHR_HSCHR19KIR_HG2393_CTG3_1 2006369839 2017-01-19 11:45:17
  CHR_HSCHR1_6_CTG3 2006369781 2017-01-19 11:45:17
  CHR_HSCHR19KIR_CA04_CTG3_1 2006369833 2017-01-19 11:45:17
  CHR_HG926_PATCH 2006369801 2017-01-19 11:45:17
  CHR_HSCHR19KIR_CA01-TA01_1_CTG3_1 2006369813 2017-01-19 11:45:17
  CHR_HSCHR19KIR_CA01-TB04_CTG3_1 2006369817 2017-01-19 11:45:17
  CHR_HSCHR4_12_CTG12 2006369785 2017-01-19 11:45:17
  CHR_HG2068_PATCH 2006369795 2017-01-19 11:45:17
  CHR_HSCHR19KIR_502960008-1_CTG3_1 2006369825 2017-01-19 11:45:17
  CHR_HG2046_PATCH 2006369805 2017-01-19 11:45:17
  CHR_HG2285_HG106_HG2252_PATCH 2006369803 2017-01-19 11:45:17
  CHR_HG2266_PATCH 2006369793 2017-01-19 11:45:17
  CHR_HG2067_PATCH 2006369797 2017-01-19 11:45:17
  CHR_HSCHR19KIR_CA01-TA01_2_CTG3_1 2006369815 2017-01-19 11:45:17
  CHR_HSCHR19KIR_HG2396_CTG3_1 2006369837 2017-01-19 11:45:17
  CHR_HG30_PATCH 2006369789 2017-01-19 11:45:17
  CHR_HSCHR19KIR_502960008-2_CTG3_1 2006369823 2017-01-19 11:45:17
  CHR_HSCHR5_8_CTG1 2006369787 2017-01-19 11:45:17
  CHR_HSCHR17_3_CTG1 2006369807 2017-01-19 11:45:17
CHANGED patches
DELETED patches

DnaFrags to delete:
  names:
  dnafrag_ids:
Input for create_patch_pairaligner_conf.pl:
--patches chromosome:CHR_HG1708_PATCH,chromosome:CHR_HSCHR19KIR_CA01-TA01_1=
_CTG3_1,chromosome:CHR_HSCHR4_12_CTG12,chromosome:CHR_HSCHR19KIR_HG2396_CTG=
3_1,chromosome:CHR_HSCHR17_3_CTG1,chromosome:CHR_HSCHR5_8_CTG1,chromosome:C=
HR_HSCHR19KIR_7191059-1_CTG3_1,chromosome:CHR_HSCHR19KIR_0019-4656-B_CTG3_1=
,chromosome:CHR_HSCHR19KIR_CA04_CTG3_1,chromosome:CHR_HG926_PATCH,chromosom=
e:CHR_HSCHR19KIR_CA01-TB04_CTG3_1,chromosome:CHR_HG2046_PATCH,chromosome:CH=
R_HG2285_HG106_HG2252_PATCH,chromosome:CHR_HG2067_PATCH,chromosome:CHR_HSCH=
R19KIR_HG2394_CTG3_1,chromosome:CHR_HSCHR19KIR_0019-4656-A_CTG3_1,chromosom=
e:CHR_HSCHR19KIR_7191059-2_CTG3_1,chromosome:CHR_HSCHRX_3_CTG7,chromosome:C=
HR_HG2236_PATCH,chromosome:CHR_HSCHR17_11_CTG4,chromosome:CHR_HSCHR1_6_CTG3=
,chromosome:CHR_HSCHR19KIR_502960008-1_CTG3_1,chromosome:CHR_HG2266_PATCH,c=
hromosome:CHR_HSCHR19KIR_502960008-2_CTG3_1,chromosome:CHR_HG2088_PATCH,chr=
omosome:CHR_HSCHR19KIR_0010-5217-AB_CTG3_1,chromosome:CHR_HSCHR19KIR_HG2393=
_CTG3_1,chromosome:CHR_HSCHR19KIR_CA01-TB01_CTG3_1,chromosome:CHR_HG2068_PA=
TCH,chromosome:CHR_HSCHR19KIR_CA01-TA01_2_CTG3_1,chromosome:CHR_HG30_PATCH<=
/pre>=20
</div>
</div>
<p>Copy the output to the Intentions for Release page as it will be needed =
to clean-up the alignments</p>
<p>In this case, there are 14 NEW patches, 1 CHANGED patch and 1 DELETED pa=
tch. They can be imported to / deleted from the master database by running =
update_genome.pl with the --force option</p>
<p><br></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Add patches</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/update_genome.pl --reg=
_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg=
_ebi_conf.pl --compara compara_master --species human --force</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<p class=3D"title">Running LASTZ for patches</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>The steps for running the pairwise alignment pipeline for new patches ca=
n be found here: $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/docs/pipelines/READM=
Es/pair_aligner_patches.rst</p>
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"471"><p>Add in the new LRGs</p=
>
<div id=3D"expander-229338221" class=3D"expand-container">
<div id=3D"expander-control-229338221" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-229338221" class=3D"expand-content">
<p>LRGs are needed by the Family pipeline, and have to be updated every rel=
ease. This is done by running the update_genome.pl script on human with the=
 --force option</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/update_genome.pl --reg=
_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg=
_ebi_conf.pl --compara compara_master --species human --force</pre>=20
</div>
</div>
<p><strong>Note that the new LRGs may have already been loaded by the previ=
ous step (<em>add in the human patches</em>) as the same update_genome.pl c=
ommand is run</strong></p>
<p>To check if everything loaded OK, compare the output of the following qu=
eries:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl --reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/produc=
tion_reg_ebi_conf.pl --reg_type core --reg_alias human -sql 'select count(*=
) from seq_region join coord_system cs using(coord_system_id) where cs.name=
=3D"lrg"'
&nbsp;
db_cmd.pl --reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline=
/production_reg_ebi_conf.pl --reg_alias compara_master -sql 'select count(*=
) from dnafrag where coord_system_name=3D"lrg"'</pre>=20
</div>
</div>
<p>they should be the same.</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"629"><p>Load the divergence ti=
mes from TimeTree</p>
<div id=3D"expander-196857803" class=3D"expand-container">
<div id=3D"expander-control-196857803" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-196857803" class=3D"expand-content">
<p>This will do searches on the TimeTree website to find divergence times o=
f all the clades that are represented in the master database</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">standal=
oneJob.pl Bio::EnsEMBL::Compara::RunnableDB::SpeciesTree::LoadTimeTree -reg=
_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg=
_ebi_conf.pl -compara_db compara_master -debug 1</pre>=20
</div>
</div>
<p>Additionally you could check the results by running the following query =
on the master database (and compare with the previous release database if n=
eeded):</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">SELECT =
name_class , COUNT(*) FROM ncbi_taxa_name GROUP BY name_class;
rel. 93: | ensembl timetree mya |       79 |
rel. 94: | ensembl timetree mya |       99 |</pre>=20
</div>
</div>
<p><br></p>
<p><br></p>
<div class=3D"confluence-information-macro confluence-information-macro-tip=
">
<span class=3D"aui-icon aui-icon-small aui-iconfont-approve confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>If TimeTree is down, copy the data from the last release:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_prev -executable mysqldump --prepend --insert-ignor=
e --prepend --no-create-info --prepend --where=3D"name_class =3D 'ensembl t=
imetree mya'" ncbi_taxa_name | db_cmd.pl $COMPARA_REG compara_master</pre>=
=20
</div>
</div>
</div>
</div>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Addmethod_link_species_setentrie=
stocomparamasterdatabase">Add method_link_species_set entries to compara ma=
ster database</h2>
<p>The release coordinator (or any team member) should create a new method_=
link_species_set in the master database before starting a new pipeline in o=
rder to get a unique method_link_species_set_id. Ideally they can be create=
d before starting to build the new database although new method_link_specie=
s_sets can be added later on.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"618"><p>Specific mlss_ids can =
be created with <code>create_mlss.pl</code> (see <a href=3D"/seqdb/confluen=
ce/display/EnsCom/Master+database">Master database</a>), but we have anothe=
r script that will bulk-create all the mlss_ids we need</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/create_all_mlss.pl --r=
eg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_r=
eg_ebi_conf.pl --compara compara_master -xml $ENSEMBL_CVS_ROOT_DIR/ensembl-=
compara/scripts/pipeline/compara_ensembl.xml --release --verbose</pre>=20
</div>
</div><p>The script will report all the MethodLinkSpeciesSets that it needs=
 to create, with a summary of what it has created</p></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"537"><p>Reset the URL of reuse=
d mlss_ids<br>In case the same mlss_id can be reused, the pipeline will pro=
bably complain that there is already a URL attached to it. You need to rese=
t these URLs</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">UPDATE m=
ethod_link_species_set SET url =3D "" WHERE method_link_species_set_id IN (=
&lt;LIST_OF_mlss_ids&gt;);</pre>=20
</div>
</div><p>Usually, this happens when there are no new assemblies, in which c=
ase you need to give the mlss_id of the Family, ncRNA-tree and protein-tree=
 pipelines</p></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Finaleditstocomparamasterdatabas=
e">Final edits to compara master database</h2>
<p>This runs once all the species have been added / updated.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"517"><p>Compare the staging se=
rvers to the master database</p>
<div id=3D"expander-984703280" class=3D"expand-container">
<div id=3D"expander-control-984703280" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-984703280" class=3D"expand-content">
<p>This script will list the genomes of the staging servers, and compare th=
em to the master database.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence"># Run o=
nce in dry-run mode to see the changes
perl $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/update_master_d=
b.pl --reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/prod=
uction_reg_ebi_conf.pl --compara compara_master --dry_run</pre>=20
</div>
</div>
<p>** note: The above might throw a warning about not finding any species n=
ame in the ancestral db, this is expected and should not break the test!!</=
p>
<p>Some things (like the genebuild date is different) can be directly chang=
ed by the script (use the --nodry-run option instead). If there is a new as=
sembly / species on the staging servers that is not yet in the master datab=
ase, run update_genome.pl (see above) to add it, and re-run update_master_d=
b.pl to make sure things are solved.</p>
</div>
</div></li>
<li data-inline-task-id=3D"635"><p>Healthcheck the master database</p>
<div id=3D"expander-867955889" class=3D"expand-container">
<div id=3D"expander-control-867955889" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-867955889" class=3D"expand-content">
<p>See <a href=3D"/seqdb/confluence/display/EnsCom/JAVA+Healthchecks">JAVA =
Healthchecks</a> and use the ComparaMaster group</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">#cd to =
your local repo of healthcheck
cd ensj-healthcheck/
$ENSEMBL_CVS_ROOT_DIR/ensj-healthcheck/run-configurable-testrunner.sh $(mys=
ql-ens-compara-prod-1 details script) -d ensembl_compara_master --release $=
CURR_ENSEMBL_RELEASE -g ComparaMaster</pre>=20
</div>
</div>
<p>possible errors:</p>
<p>"""</p>
<p>org.ensembl.healthcheck.testcase.compara.CheckTaxon [Team responsible: C=
OMPARA]<br> ensembl_compara_master: name::Saccharomyces cerevisiae is not i=
n saccharomyces_cerevisiae_core_94_4<br> saccharomyces_cerevisiae_core_94_4=
: name::Saccharomyces cerevisiae S288C is not in ensembl_compara_master<br>=
 ensembl_compara_master: classification:: Saccharomycetaceae Saccharomyceta=
les Saccharomycetes Saccharomycotina saccharomyceta Ascomycota Dikarya Fung=
i Opisthokonta Eukaryota is not in saccharomyces_cerevisiae_core_94_4<br> s=
accharomyces_cerevisiae_core_94_4: classification:: Saccharomyces cerevisia=
e Saccharomycetaceae Saccharomycetales Saccharomycetes Saccharomycotina sac=
charomyceta Ascomycota Dikarya Fungi Opisthokonta Eukaryota is not in ensem=
bl_compara_master</p>
<p>"""</p>
<p>There is nothing that compara can do about this error. Report it to prod=
uction/core. The name in core needs to be updated to what is on the NCBI ta=
xon tables</p>
</div>
</div></li>
<li data-inline-task-id=3D"636"><p>Backup the master database (one more tim=
e)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">mysql-e=
ns-compara-prod-1 mysqldump ensembl_compara_master &gt; /nfs/production/pan=
da/ensembl/warehouse/compara/master_db_dumps/ensembl_compara_master.$(date =
'+%Y%m%d').during${CURR_ENSEMBL_RELEASE}.sql</pre>=20
</div>
</div></li>
</ul>
<h1 id=3D"Releasecoordinationdocumentation-Production">Production</h1>
<h2 id=3D"Releasecoordinationdocumentation-Pre-productiontasks">Pre-product=
ion tasks</h2>
<h3 id=3D"Releasecoordinationdocumentation-Coredatabases">Core databases</h=
3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"609"><p>Some of our pipelines =
intensively use the Core databases. To avoid overloading the Ensembl-wide s=
taging server (mysql-ens-sta-1), copy all the core databases to mysql-ens-v=
ertannot-staging with this script:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_all_core_databases.pl<=
/pre>=20
</div>
</div><p>But first try to clean up the server by removing the databases of =
the previous release !<br>The script will list:</p>
<ul>
<li>the databases already present on mysql-ens-vertannot-staging with the s=
ame <em>database name</em>. Check with the genebuilders that the assembly a=
nd geneset they contain is the same as on mysql-ens-sta-1</li>
<li>the databases already present on mysql-ens-vertannot-staging with the s=
ame <em>species name</em>. Check with the genebuilders what they contain an=
d whether they can be dropped, as the Registry will be confused if it finds=
 two databases for the same species</li>
</ul><p>If there are any, you will have to add the --force option to ignore=
 the warnings and do the copy.</p></li>
<li class=3D"checked" data-inline-task-id=3D"632"><p>if you are interested =
in updating all the core db in your target server use the --update option<b=
r>In reality, the script doesn't copy the databases itself, but <em>submits=
</em> copy jobs on the Ensembl Production self-service API. Check on <a hre=
f=3D"http://ens-prod-1.ebi.ac.uk:8000/#!/copy_list" class=3D"external-link"=
 rel=3D"nofollow">http://ens-prod-1.ebi.ac.uk:8000/#!/copy_list</a> that th=
e jobs have completed successfully.</p></li>
</ul>
<h3 id=3D"Releasecoordinationdocumentation-Linuxbrewpaths">Linuxbrew paths<=
/h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"610"><p>As the linuxbrew insta=
llation can sometimes go awry, run this test to check that all the paths ar=
e valid</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">prove $=
ENSEMBL_CVS_ROOT_DIR/ensembl-compara/modules/t/housekeeping_checkAllLinuxbr=
ewPaths.t</pre>=20
</div>
</div><p>If you find anything wrong, report that to the group so that it ca=
n be fixed before starting the pipelines</p></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Mainsite">Main site</h2>
<p>List the pipelines that have to be run on the <em> <a href=3D"/seqdb/con=
fluence/display/EnsCom/Release+plans">Intentions for Release</a> </em> page=
 and schedule the work with the rest of the team.</p>
<h3 id=3D"Releasecoordinationdocumentation-LastZs">LastZs</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li data-inline-task-id=3D"633">Any programmed LastZ can already be started=
 at this point. It is important to start them ASAP in order to save time.</=
li>
</ul>
<h3 id=3D"Releasecoordinationdocumentation-Members">Members</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"611"><p>As of release 90, memb=
ers are preloaded before any gene-homology pipelines are run. Use the follo=
wing pipeline to load the members:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::EBI::Ensembl::LoadMembers_conf=
 --collection ensembl</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-tip=
">
<span class=3D"aui-icon aui-icon-small aui-iconfont-approve confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
Remember to pass the=20
<code>member_db</code> parameter to the other production pipelines at initi=
alisation (ProteinTrees, Families, etc), or update the parameter in the Pip=
eConfig files!!
</div>
</div></li>
</ul>
<h3 id=3D"Releasecoordinationdocumentation-Genomedumps">Genome dumps</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"624"><p>As of release 94, geno=
me DNA sequences are dumped to FASTA file before any multiple-alignment pip=
elines are run. Use the following pipeline to start the dumps</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::EBI::DumpGenomes_conf --collec=
tion ensembl</pre>=20
</div>
</div><p>The dumps will be put under <code>/hps/nobackup2/production/ensemb=
l/compara_ensembl/genome_dumps/</code>, which all of multiple-alignment pip=
elines are configured to use.</p><p><br></p></li>
</ul>
<h3 id=3D"Releasecoordinationdocumentation-Species-tree">Species-tree</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"612"><p>We now have a species-=
tree pipeline that generates the species-tree used by all the pipelines. As=
 soon as the <strong>unmasked</strong> genome dumps are done, use the follo=
wing command to generate the new species tree:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::CreateSpeciesTree_conf -host m=
ysql-ens-compara-prod-X -port XXXX -output_file $ENSEMBL_CVS_ROOT_DIR/ensem=
bl-compara/scripts/pipeline/species_tree.ensembl.branch_len.nw</pre>=20
</div>
</div><p>Note that, by default, the pipeline runs on all members of the '<e=
m>ensembl</em>' collection.</p><p>Check that the tree has been rooted corre=
ctly. If it hasn't, we can do it in&nbsp;<a href=3D"http://tree.bio.ed.ac.u=
k/software/figtree/" class=3D"external-link" rel=3D"nofollow">FigTree</a>:<=
/p><p>&nbsp; &nbsp; &nbsp; &nbsp;1. open the file<br>&nbsp; &nbsp; &nbsp; &=
nbsp;2. select&nbsp;<em>saccharomyces_cerevisiae</em> and click the 'Reroot=
' button (<span class=3D"confluence-embedded-file-wrapper confluence-embedd=
ed-manual-size"><img class=3D"confluence-embedded-image confluence-thumbnai=
l" width=3D"30" src=3D"f8b17f04c9cf89158e086ecea6b31a57" data-image-src=3D"=
/seqdb/confluence/download/attachments/21174007/FigTree_reroot_button.png?v=
ersion=3D1&amp;modificationDate=3D1525347742820&amp;api=3Dv2" data-unresolv=
ed-comment-count=3D"0" data-linked-resource-id=3D"73864511" data-linked-res=
ource-version=3D"1" data-linked-resource-type=3D"attachment" data-linked-re=
source-default-alias=3D"FigTree_reroot_button.png" data-base-url=3D"https:/=
/www.ebi.ac.uk/seqdb/confluence" data-linked-resource-content-type=3D"image=
/png" data-linked-resource-container-id=3D"21174007" data-linked-resource-c=
ontainer-version=3D"2990" height=3D"31"></span>). <br>&nbsp; &nbsp; &nbsp; =
&nbsp;3. go to File &gt; Export Trees. Select Newick from the dropdown menu=
 and check the box marked 'Save as currently displayed'<br> <br> <span styl=
e=3D"color: rgb(112,112,112);">Once finished, copy the output file to&nbsp;=
</span> <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/specie=
s_tree.ensembl.branch_len.nw</code> <span style=3D"color: rgb(112,112,112);=
">, commit it and push.</span></p></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-GRCh37site">GRCh37 site</h2>
<p>Ensembl maintains a special archive site for the previous human assembly=
 (GRCh37): <a href=3D"http://grch37.ensembl.org" class=3D"external-link" re=
l=3D"nofollow">http://grch37.ensembl.org</a> . Whenever we release an impor=
tant new method / feature, we need to consider doing it for GRCh37 too, see=
 <a href=3D"/seqdb/confluence/display/EnsCom/GRCh37+website">GRCh37 website=
</a> for more information.</p>
<h1 id=3D"Releasecoordinationdocumentation-Endofproductionwindow">End of pr=
oduction window</h1>
<h2 id=3D"Releasecoordinationdocumentation-CreateReleaseDatabase">Create Re=
lease Database</h2>
<p>Create the new database for the new release and add it to your registry =
configuration file. Use the $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/sql/table=
.sql file to create the tables and populate the database with the relevant =
primary data and genomic alignments that can be reused from the previous re=
lease. This can be done with the $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scri=
pts/pipeline/populate_new_database.pl script.&nbsp; It requires the master =
database, the previous released database and the fresh new database with th=
e tables already created. The script will copy relevant data from the maste=
r and the old database into the new one.</p>
<p><br></p>
<p>***NOTE***</p>
<p>Remember to&nbsp;run `mysqlanalyze` and `mysqloptimize`&nbsp;regularly t=
hroughout the merging on the release db.</p>
<p>It can be a bit expensive, like re-enabling the keys, so not something t=
o do at every step. But from time to time it can help</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"348"><p>Create new database</p=
>
<div id=3D"expander-6718052" class=3D"expand-container">
<div id=3D"expander-control-6718052" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-6718052" class=3D"expand-content">
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Create database</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_curr -sql "CREATE DATABASE"
db_cmd.pl $COMPARA_REG compara_curr &lt; $ENSEMBL_CVS_ROOT_DIR/ensembl-comp=
ara/sql/table.sql=20
</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"645"><p>Populate the new datab=
ase</p>
<div id=3D"expander-513695390" class=3D"expand-container">
<div id=3D"expander-control-513695390" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-513695390" class=3D"expand-content">
<p>Before you start copying, make a dry run of the populate_new_database.pl=
 with -intentions flag to review the list of mlss_ids to be copied:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>populate_new_database intentions</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/populate_new_database.pl --=
reg-conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_=
reg_ebi_conf.pl \=20
--master compara_master --old compara_prev --new compara_curr --intentions =
&gt; populate_new_database.intentions</pre>=20
</div>
</div>
<p>This normally takes less than a minute and produces a long list.</p>
<p>If you believe some of the MLSS or SS entries should NOT be copied, conn=
ect to the master database and change the last_release of the unwanted entr=
ies to the previous release number. <span style=3D"line-height: 1.4285715;"=
>Conversely, if you want to prepare some new MLSS or SS entries to be copie=
d (e.g. the newly run pipelines), change the first_release of the wanted en=
tries to the current release number.</span></p>
<p><span style=3D"line-height: 1.4285715;">NB: OLD INSTRUCTIONS FOR PRE-fir=
st_release/last_release API: <em>There are cases where the mlss does not ch=
ange but the underlying data does, e.g. the "patch-to-ref" alignment (H.sap=
-H.sap lastz-patch and M.mus-M.mus lastz-patch). These have a mlss_id of 55=
6 (H.sap)&nbsp; and 624 (M.mus) and are currently set in the skip_mlss. If =
there are no new patches, this needs to be removed to allow the existing da=
ta to be copied. If there are new patches, please ensure the 'skip_mlss' is=
 set in the meta table. However, the entry in the method_link_species_set t=
able will not be copied and will need to be added manually.</em> </span></p=
>
<p><span style=3D"line-height: 1.4285715;"> <br> </span></p>
<h3 id=3D"Releasecoordinationdocumentation-Theremovalofolddatashouldn'tbene=
cessaryunlesstheskip_mlssentriesarenotuptodate.Howeverifyouneedtoremoveoldd=
atafromthereleasedbfollowtheinstructionsbelow">The removal of old data shou=
ldn't be necessary unless the skip_mlss entries are not up to date. However=
 if you need to remove old data from the release db follow the instructions=
 below</h3>
<p><span style=3D"line-height: 1.4285715;"> <a href=3D"/seqdb/confluence/di=
splay/EnsCom/Removal+of+old+data+from+Release+DB">Removal of old data from =
Release DB</a> <br> </span></p>
<p>Start the copying:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>populate_new_database</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/populate_new_database.=
pl \
--reg-conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/productio=
n_reg_ebi_conf.pl --master compara_master --old compara_prev --new compara_=
curr &gt; populate_new_database.out</pre>=20
</div>
</div>
<div id=3D"expander-1745138987" class=3D"expand-container">
<div id=3D"expander-control-1745138987" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for run times</span>
</div>
<div id=3D"expander-content-1745138987" class=3D"expand-content">
<p>rel. 94: 679m18.736s</p>
<p>rel. 93: 343m46.507s</p>
<p>rel. 91: 240m55.310s</p>
<p>rel. 88: 640m18.007s</p>
<p><br></p>
<p>took 351m23.029s (~5.85 hours) for rel.87</p>
<p>took 3 hours for rel.pre57 (copied from rel.56)<br> took 3 hours for rel=
.57 (copied from rel.pre57)<br> took 2:15 hours for rel.58 (copied from rel=
.57)<br> took 2:09 hours for rel.59 (copied from rel.58)<br> took 3 hours f=
or rel. 60 (copied from rel.59)<br> rel.64:&nbsp;2.6h<br> rel.65:&nbsp;2.5h=
<br> rel.66:&nbsp;4.8h<br> rel.67:&nbsp;2.1h (launched from compara3)<br> r=
el.68:&nbsp;1h40m (run on compara3)<br> rel.69:&nbsp;2.5h<br> rel.70:&nbsp;=
~3.5h (compara1 was slow)<br> rel.71:&nbsp;4.1h (compara3)<br> rel.72: 5.1h=
 (compara3)<br> rel.73: 5.5h (compara2)<br> rel.74: 2h:3' (compara3)<br> re=
l.75: 5.5h (compara5)<br> rel.77: 9.7h (compara5)<br> rel.78: 6.0h (compara=
4)<br> rel.79:<br> rel.80:<br> rel.81: 6h (compara5)&nbsp;</p>
<p>rel.82: 5.5h (compara5)</p>
<p><span>rel.83: 4.8h (compara5)</span></p>
<p><span>rel.85: 7.5h (compara5)</span></p>
</div>
</div>
<p>If new method_link_species_sets are added in the master after this, you =
use this script again to copy the new relevant data. In such case, you will=
 have to:</p>
<p>&nbsp;- skip the old_database in order to avoid trying to copy the dna-d=
na alignments and syntenies again</p>
<p>&nbsp;- empty ncbi_taxa_name before running</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>populate_new_database from master only</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/populate_new_database.pl \
--reg-conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/productio=
n_reg_conf.pl --master compara_master --new compara_curr</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"473"><p>Delete any pairwise al=
ignments on non-reference patches that have been DELETED or UPDATED.</p>
<div id=3D"expander-148627450" class=3D"expand-container">
<div id=3D"expander-control-148627450" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-148627450" class=3D"expand-content">
<p>Find the output of <span style=3D"line-height: 1.4285715;">find_assembly=
_patches.pl script that you ran previously (usually for Human and Mouse) an=
d combine their "Dnafrags to delete" into one common list:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>delete patches</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">DNAFRAG=
S_2_DELETE=3D"(14025314,14025313)"
&nbsp;
db_cmd.pl $COMPARA_REG compara_curr -sql "SELECT count(*) FROM genomic_alig=
n ga1, genomic_align ga2, genomic_align_block gab WHERE ga1.genomic_align_b=
lock_id =3D ga2.genomic_align_block_id AND ga1.genomic_align_id !=3D ga2.ge=
nomic_align_id AND  ga1.genomic_align_block_id =3D gab.genomic_align_block_=
id AND ga1.dnafrag_id in $DNAFRAGS_2_DELETE"
&nbsp;
db_cmd.pl $COMPARA_REG compara_curr -sql "DELETE ga1, ga2, gab FROM genomic=
_align ga1, genomic_align ga2, genomic_align_block gab WHERE ga1.genomic_al=
ign_block_id =3D ga2.genomic_align_block_id AND ga1.genomic_align_id !=3D g=
a2.genomic_align_id AND  ga1.genomic_align_block_id =3D gab.genomic_align_b=
lock_id AND ga1.dnafrag_id in $DNAFRAGS_2_DELETE"</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"641"><p>Run healthchecks on th=
e release database</p>
<div id=3D"expander-1132494717" class=3D"expand-container">
<div id=3D"expander-control-1132494717" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1132494717" class=3D"expand-content">
<p>Run the healthchecks to make sure the the release database is consistent=
 after the initial population of data.</p>
<p>Click <a href=3D"http://www.ebi.ac.uk/seqdb/confluence/display/EnsCom/Re=
lease+coordination+documentation#Releasecoordinationdocumentation-Runthehea=
lthchecks" class=3D"external-link" rel=3D"nofollow">here</a> for how to set=
up and run the healthchecks</p>
<p>Run the compara_external_foreign_keys healthcheck</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>healthcheck</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensj-healthcheck
&nbsp;
# make sure you are using the right version of JAVA:
export JAVA_HOME=3D/nfs/software/ensembl/latest/linuxbrew/opt/jdk@8
=20
# if you need to recompile (submit to the farm, because you need more memor=
y than is available on the head) :
bsub -I ant clean jar

# some tests need more memory than the farm3's default:
time bsub -q production-rh7 -M8000  -R"select[mem&gt;8000]  rusage[mem=3D80=
00]" -I ./run-configurable-testrunner.sh $(mysql-ens-compara-prod-1 details=
 script) -d ensembl_compara_88 --release $CURR_ENSEMBL_RELEASE -g ComparaSh=
ared</pre>=20
</div>
</div>
<p><br></p>
<p><strong>At this point its OK to have some unused method_links since they=
 will be removed later. But should NOT be removed now since they may still =
be used by the merging.</strong></p>
<p><span> <br> </span></p>
<div id=3D"expander-702780638" class=3D"expand-container">
<div id=3D"expander-control-702780638" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for run times</span>
</div>
<div id=3D"expander-content-702780638" class=3D"expand-content">
<p>rel. 94: 17m46.121s</p>
<p>rel.88 1:15m</p>
<p>rel.83: 13 minutes, 2 expected complaints (<span style=3D"line-height: 1=
.4285715;">CheckSpeciesSetSizeByMethod may complain about Human-on-Human la=
stz-new and </span> <span style=3D"line-height: 1.4285715;">ForeignKeyMaste=
rTables will complain about empty MethodLink entries (this will be deleted =
later in the merging process) )</span></p>
<p>rel.85: 20mins</p>
</div>
</div>
<p>and correct any newly detected problems</p>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-MergeDNAdata">Merge DNA data</h2=
>
<p><span style=3D"color: rgb(255,0,0);">NOTE:</span> All the runs of copy_d=
ata.pl (except the last one) should have the flag "-re_enable 0" to avoid r=
ecomputing the indices in the end of each run.</p>
<p>Running "-re_enable 1" will add <span style=3D"color: rgb(255,0,255);"> =
<em>at least 2 hours</em> </span>&nbsp;(rel.82) to the merging time (but it=
 is necessary in the final product) so make sure you only do it once.</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"623"><p><span>Pairwise alignme=
nts: LASTZ_NET (and, formerly, BLASTZ_NET or&nbsp;</span> <span style=3D"li=
ne-height: 1.4285715;">TRANSLATED_BLAT_NET</span> <span style=3D"line-heigh=
t: 1.4285715;">)</span></p><p>*NOTE* : For merging pw alignments involving =
haplotypes, go to the next point</p>
<div id=3D"expander-887775297" class=3D"expand-container">
<div id=3D"expander-control-887775297" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-887775297" class=3D"expand-content">
<p>These data are usually in separate production databases. You can copy th=
em using the $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_da=
ta.pl script. This script requires write access to the production database =
if the dnafrag_ids need fixing. Use the flag -re_enable 0 on all calls apar=
t from the last one to avoid recomputing the indices.</p>
<p>Also, check first_release of these databases. In case it hasn't been set=
, you need to do it <strong>now</strong> on <strong>both</strong> the produ=
ction database and the master database,</p>
<p>Example:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>copy_data</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">    # f=
or each source URL [there may be several sources, remember to add all of th=
em]: first plug in the --from_url and add --dry_run to check that the scrip=
t has found the right MLSS:
$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_c=
onf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_c=
onf.pl --to_reg_name compara_curr --method_link_type LASTZ_NET --re_enable =
0 --from_url mysql://ensro@mysql-ens-compara-prod-3:4523/mateus_lastz_cat_h=
uman_93 --dry_run

   &nbsp;# if happy, remove the --dry_run flag and run it again, preferably=
 on the farm:
bsub -q yesterday -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000 -I tim=
e $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg=
_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg=
_conf.pl --to_reg_name compara_curr --method_link_type LASTZ_NET --re_enabl=
e 0 --from_url mysql://ensro@compara4/sf5_ggal_falb_lastz_73
</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"532"><p><span style=3D"color: =
rgb(0,51,102);"> <span style=3D"color: rgb(0,51,102);">The curious case of =
LASTZ_PATCH alignments. There is <span style=3D"color: rgb(255,0,0);"> <str=
ong>always</strong> </span> something to copy, even if there are no new pat=
ches&nbsp;</span> </span></p><p><span style=3D"color: rgb(0,51,102);"> <spa=
n style=3D"color: rgb(0,51,102);">&nbsp;</span> </span></p>
<div id=3D"expander-1129681295" class=3D"expand-container">
<div id=3D"expander-control-1129681295" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1129681295" class=3D"expand-content">
<p><span style=3D"color: rgb(0,51,102);"> <span style=3D"color: rgb(0,128,0=
);"> <span style=3D"color: rgb(0,51,102);"> <span style=3D"color: rgb(0,51,=
102);">You will also have to copy Human_ref_vs_Human_patches and Mouse_ref_=
vs_Mouse_patches LASTZ_PATCH alignments, but mind the source:</span> </span=
> </span> </span></p>
<p><span style=3D"color: rgb(0,51,102);"> <span style=3D"color: rgb(0,128,0=
);">If there were new patches</span>, you'll import them in a way similar t=
o other LASTZ:<br> </span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>copy_data</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">#First =
run the following pipeline to import the alignments between patches / haplo=
types and primary regions.  &nbsp;
&nbsp;
init_pipeline.pl Bio::EnsEMBL::Compara::PipeConfig::ImportPatchAlignmentsTo=
Ref_conf -host comparaX
&nbsp;
#then
# note the method_link_type is LASTZ_PATCH !
bsub -q yesterday -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000  -I ti=
me $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --re=
g_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_re=
g_ebi_conf.pl --to_reg_name compara_curr --method_link_type LASTZ_PATCH --r=
e_enable 0 --from_url &lt;the_url_of_the_pipeline_db_from_above&gt;
</pre>=20
</div>
</div>
<p><span style=3D"color: rgb(255,0,0);">If there were no new patches</span>=
, you will still have to copy them from compara_prev, since LASTZ_PATCH ali=
gnments are automatically skipped by <a href=3D"http://populate_new_databas=
e.pl" class=3D"external-link" rel=3D"nofollow">populate_new_database.pl</a>=
 script.&nbsp;<span>You simply have to refer to the previous database as th=
e source:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>copy_data</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">    # n=
ote the method_link_type is LASTZ_PATCH !
bsub -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000 -I time $ENSEMBL_CV=
S_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_conf $ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_ebi_conf.pl =
--to_reg_name compara_curr --method_link_type LASTZ_PATCH --re_enable 1 --f=
rom_reg_name compara_prev
</pre>=20
</div>
</div>
</div>
</div></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"302"><p>Pairwise alignments: n=
on-reference patches for the high coverage LASTZ_NET alignments. This is it=
o be used when merging pw alignments involving haplotypes.</p>
<div id=3D"expander-67660737" class=3D"expand-container">
<div id=3D"expander-control-67660737" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-67660737" class=3D"expand-content">
<p>This step is now very similar to the previous.</p>
<p>Do not forget the --merge option.</p>
<p>Also, if it's the last one you might want to switch keys back on</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>copy_data --merge --patch_merge</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">    # f=
irst plug in the --from_url and add --dry_run to check that the script has =
found the right MLSS:
bsub -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000  -I time $ENSEMBL_C=
VS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_conf $ENSEM=
BL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_ebi_conf.pl=
 --to_reg_name compara_curr --method_link_type LASTZ_NET --method_link_type=
 BLASTZ_NET --method_link_type TRANSLATED_BLAT_NET --re_enable 0 --merge --=
from_url  mysql://ensro@mysql-ens-compara-prod-1.ebi.ac.uk:4485/carlac_last=
z_human_patches_88 --dry_run
&nbsp;
    # if happy, remove the --dry_run flag and run it again, preferably on t=
he farm:
bsub -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000  -I time $ENSEMBL_C=
VS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_conf $ENSEM=
BL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_ebi_conf.pl=
 --to_reg_name compara_curr --method_link_type LASTZ_NET --method_link_type=
 BLASTZ_NET --method_link_type TRANSLATED_BLAT_NET --re_enable 1 --merge --=
from_url  mysql://ensro@mysql-ens-compara-prod-1.ebi.ac.uk:4485/carlac_last=
z_human_patches_88</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"304"><p><span>Multiple alignme=
nts: PECAN, EPO, EPO_LOW_COVERAGE, GERP_CONSTRAINED_ELEMENT, GERP_CONSERVAT=
ION_SCORE</span></p>
<div id=3D"expander-1879951975" class=3D"expand-container">
<div id=3D"expander-control-1879951975" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1879951975" class=3D"expand-content">
<p>These data are usually in separate production databases. You can copy th=
em using the $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_da=
ta.pl script. This script requires write access to the production database =
if the dnafrag_ids need fixing or the data must be copied in binary mode (t=
his is required for conservation scores).</p>
<p>Some alignments produce conservation scores and constrained elements (ch=
eck the&nbsp;<a href=3D"/seqdb/confluence/display/EnsCom/Release+plans">Rel=
ease plans</a>) and these need to be copied separately.</p>
<p>eg</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>copy_data multiple alignment</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">    bsu=
b -q yesterday -R "select[mem&gt;5000] rusage[mem=3D5000]" -M5000 \
    -I time $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_dat=
a.pl \
    --reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/produ=
ction_reg_ebi_conf.pl --to_reg_name compara_curr \
    --method_link_type EPO --method_link_type EPO_LOW_COVERAGE --method_lin=
k_type PECAN \
    --method_link_type GERP_CONSTRAINED_ELEMENT --method_link_type GERP_CON=
SERVATION_SCORE \
    --from_url mysql://ensro@compara2/sf5_epo_low_8way_fish_71 -re_enable 0=
</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"463"><p>Check the keys have be=
en re-enabled</p>
<div id=3D"expander-1014618189" class=3D"expand-container">
<div id=3D"expander-control-1014618189" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1014618189" class=3D"expand-content">
<p>Use mysqlshow to highlight if the table still has disabled keys. The tex=
t "disabled" will be shown in the Comment column if the key is disabled. An=
 empty Comment column indicates the keys are enabled.</p>
<p>mysqlshow interprets any underscores in the last argument as a wildcard =
so to get round this, we need to use % as the last argument.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>mysqlshow</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG compara_curr --executable mysqlshow  -- --keys  genomic_ali=
gn_block %
db_cmd.pl $COMPARA_REG compara_curr --executable mysqlshow -- --keys genomi=
c_align %
db_cmd.pl $COMPARA_REG compara_curr --executable mysqlshow  -- --keys  geno=
mic_align_tree %
db_cmd.pl $COMPARA_REG compara_curr --executable mysqlshow  -- --keys  cons=
ervation_score %
db_cmd.pl $COMPARA_REG compara_curr --executable mysqlshow  -- --keys  cons=
trained_element %</pre>=20
</div>
</div>
<p>If there are still tables with keys disabled run the following on them:<=
/p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.p=
l $COMPARA_REG compara_curr -sql "ALTER TABLE &lt;table_name&gt; ENABLE KEY=
S";</pre>=20
</div>
</div>
</div>
</div><p><span>&nbsp;</span> <span> <br> </span></p></li>
<li class=3D"checked" data-inline-task-id=3D"621"><p><span>Syntenies</span>=
</p>
<div id=3D"expander-1929074922" class=3D"expand-container">
<div id=3D"expander-control-1929074922" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1929074922" class=3D"expand-content">
<p>First make sure the entries in $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scr=
ipts/pipeline/production_reg_ebi_conf.pl file point at the latest (staging)=
 versions of the core databases.</p>
<p><br></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Inititate Synteny pipeline on the merged database</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::EBI::Synteny_conf -pipeline_na=
me synteny_93 -alignment_db mysql://ensro@mysql-ens-compara-prod-1:4485/ens=
embl_compara_93</pre>=20
</div>
</div>
<p><span style=3D"letter-spacing: 0.0px;">Before running the code... Ensure=
 that you check the synteny coverage and if it is less than 1%, It must be =
deleted from mlss, mlss_tag, dnafrag_region and synteny_region tables. **Th=
is should be automated in the synteny pipeline by release 84.</span></p>
<p>Example</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>load synteny data</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMB=
L_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_conf $EN=
SEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_ebi_conf=
.pl --to_reg_name compara_curr --method_link_type SYNTENY --from_url mysql:=
//ensro@compara1/cc21_synteny_83 --dry_run
$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/copy_data.pl --reg_c=
onf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/pipeline/production_reg_e=
bi_conf.pl --to_reg_name compara_curr --method_link_type SYNTENY --from_url=
 mysql://ensro@compara1/cc21_synteny_83 </pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"647"><p><span>Build a new ance=
stral sequence core database</span></p>
<div id=3D"expander-1385974398" class=3D"expand-container">
<div id=3D"expander-control-1385974398" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1385974398" class=3D"expand-content">
<p>Putting together the database of ancestral sequence is now done using a =
dedicated Hive-Core mini-pipeline.</p>
<p>Check you have the most recent core checkout ie the correct schema and p=
atch files are added to the meta table.</p>
<p>&nbsp;&nbsp;&nbsp; Go to $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/modules/B=
io/EnsEMBL/Compara/PipeConfig and open the PipeConfig file AncestralMerge_c=
onf.pm .</p>
<p>&nbsp;&nbsp;&nbsp; Make sure you have edited/checked the following:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1) current release number</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2) names and locations of cur=
rent and previous ancestral core databases</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3) the table of ancestral seq=
uence sources in the second analysis (some entries might point to the previ=
ous release ancestral database, some will be new)</p>
<p>&nbsp;&nbsp;For (3), you can run the following query on your release dat=
abase and on the previous database: (NB: method_link_id=3D13 is equivalent =
to method_link_type =3D "EPO")</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>EPO query</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">SELECT =
* FROM method_link_species_set WHERE method_link_id =3D 13; </pre>=20
</div>
</div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The new mlss_id should be attached to the=
ir production database:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=
 '641' =3D&gt; '<a rel=3D"nofollow">mysql://ensro@compara3/sf5_3birds_ances=
tral_sequences_core_71</a>' <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The mlss_id =
that are reused should be linked to the previous database<br>&nbsp;&nbsp;&n=
bsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '505' =3D&gt; $self-&gt;o('prev_ancestra=
l_db'),</p>
<p>The current (as or rel.75) list of ancestral alignments are:</p>
<p>5 teleost fish<br> 6 primates<br> 4 sauropsids ("birds")<br> 15 eutheria=
n mammals</p>
<p>Save the changes, exit the editor and run init_pipeline.pl with this fil=
e:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>init_pipeline</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl AncestralMerge_conf.pm -host mysql-ens-compara-prod-1</pre>=20
</div>
</div>
<p>Then run both -sync and -loop variations of the beekeeper.pl command sug=
gested by init_pipeline.pl . This pipeline will merge the separate ancestra=
l core sources into ensembl_ancestral_{rel_number}.</p>
<p>You may want to check the msg table for errors and have a look at the re=
sult of the merger:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Which Ancestral sequences do we have?</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">SELECT =
left(name,12) na, count(*), min(seq_region_id), max(seq_region_id), max(seq=
_region_id)-min(seq_region_id)+1 FROM seq_region GROUP BY na;</pre>=20
</div>
</div>
<p>If everything is ok,&nbsp;measure the time:</p>
<p><br></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>how much time did running of the pipeline take?</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">call ti=
me_analysis('%')&nbsp;</pre>=20
</div>
</div>
<div id=3D"expander-93323194" class=3D"expand-container">
<div id=3D"expander-control-93323194" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for run times</span>
</div>
<div id=3D"expander-content-93323194" class=3D"expand-content">
<p><span>rel.94: 30min</span></p>
<p>rel.93: 59min</p>
<p>rel.87: 29.5min</p>
<p><span>rel.86: 58min</span></p>
<p>rel.67: 20min<br>rel.71: 20min<br>rel.75: 21min</p>
</div>
</div>
<p>Then drop hive-specific tables:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>drop hive tables</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">CALL dr=
op_hive_tables;</pre>=20
</div>
</div>
<p>Make sure all tables are myISAM.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">&nbsp;SH=
OW TABLE STATUS where engine !=3D 'MyISAM';</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<p class=3D"title">Healthcheck Ancestral Core</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>A non-java healthcheck is available to ensure that the dnafrags in the r=
elease database are in sync with the seq_regions in the new core. Run as fo=
llows:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-compara/scripts/production/verify_ancestral_dna=
frags.pl -compara mysql://ensro@mysql-ens-compara-prod-1:4485/ensembl_compa=
ra_92 -ancestral mysql://ensro@mysql-ens-compara-prod-1:4485/ensembl_ancest=
ral_92</pre>=20
</div>
</div>
</div>
</div>
</div>
</div><p>or, if no new multiple alignments were run, copy it over from the =
previous release</p>
<div id=3D"expander-1122311902" class=3D"expand-container">
<div id=3D"expander-control-1122311902" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1122311902" class=3D"expand-content">
<p>Create a new database for ancestral sequences:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">&nbsp;db=
_cmd.pl $COMPARA_REG ancestral_curr -reg_type core -sql 'CREATE DATABASE'</=
pre>=20
</div>
</div>
<p>Copy over the data from the previous release:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">&nbsp;ti=
me db_cmd.pl $COMPARA_REG ancestral_prev -reg_type core -executable mysqldu=
mp | db_cmd.pl $COMPARA_REG ancestral_curr -reg_type core
# rel.88: 54m44.503s
# rel.85: 40mins
# took 45 minutes in rel.81
# took 42 minutes in rel.82
# took 38 minutes in rel.83
# took 38 minutes in rel.84
# took 54 minutes in rel.89
&nbsp;</pre>=20
</div>
</div>
<p>Patch the database to the current release by applying the relevant patch=
es from $ENSEMBL_CVS_ROOT_DIR/ensembl/sql or use a schema patcher script.</=
p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ENSEMBL=
_CVS_ROOT_DIR/ensembl/misc-scripts/schema_patcher.pl --host=3Dcompara5 --us=
er=3Densadmin --pass=3D${ENSADMIN_PSW} --database=3Dlg4_ensembl_ancestral_$=
{CURR_ENSEMBL_RELEASE}</pre>=20
</div>
</div>
<p>If patches were applied, make sure you have both analyzed and optimized =
the tables:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">db_cmd.=
pl $COMPARA_REG ancestral_curr -reg_type core -executable mysqlcheck -- --a=
nalyze --verbose
db_cmd.pl $COMPARA_REG ancestral_curr -reg_type core -executable mysqlcheck=
 -- --optimize --verbose</pre>=20
</div>
</div>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Mergethehomologypipelines">Merge=
 the homology pipelines</h2>
<p><br></p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"141"><p>Check that all the pip=
elines have been run and have completed. Usually, this means protein-trees =
&amp; ncRNA-trees (for the default species and for the mouse-strains), incl=
. the WGA Orthology QC, and families</p></li>
<li class=3D"checked" data-inline-task-id=3D"648"><span style=3D"line-heigh=
t: 1.4285715;">Run the <em>ImportAltAlleGroupsAsHomologies_conf</em> pipeli=
ne<br> </span></li>
<li class=3D"checked" data-inline-task-id=3D"650"><p><span>Run the <em>EBI/=
Ensembl/MergeDBsIntoRelease_conf</em>&nbsp; pipeline to merge tables from a=
ll the products into the release database<br> </span></p>
<div id=3D"expander-2116797756" class=3D"expand-container">
<div id=3D"expander-control-2116797756" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-2116797756" class=3D"expand-content">
<p>Go to $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/modules/Bio/EnsEMBL/Compara/=
PipeConfig/EBI/Ensembl/ and open the PipeConfig file MergeDBsIntoRelease_co=
nf.pm</p>
<p>&nbsp;&nbsp;&nbsp; It has&nbsp;a 'urls' hash where you will have to chan=
ge the names of the databases and possibly their locations:</p>
<p style=3D"font-size: 10.0pt;line-height: 13.0pt;color: rgb(0,0,0);font-we=
ight: normal;margin-bottom: 10.0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n=
bsp; master_db&nbsp;&nbsp;&nbsp; - is the main compara master<br>&nbsp;&nbs=
p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prev_rel_db&nbsp;&nbsp; - should point to =
the previous release database<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=
 curr_rel_db&nbsp;&nbsp; - should point to the current release database bei=
ng merged into ( not the Hive pipeline database, but purely Compara schema =
product )</p>
<p style=3D"font-size: 10.0pt;line-height: 13.0pt;color: rgb(0,0,0);font-we=
ight: normal;margin-bottom: 10.0px;"><br> protein_db - should point to the =
current ProteinTrees pipeline database<br> family_db&nbsp; - should point t=
o the current Families pipeline database<br> ncrna_db&nbsp;&nbsp; - should =
point to the current ncRNAtrees pipeline database<br> mouse_prot_db - shoul=
d point to the current mouse-strains ProteinTrees pipeline database<br> mou=
se_ncrna_db - should point to the current mouse-strains ncRNAtrees pipeline=
 database<br> projection_db - should point to the latest run of the ImportA=
ltAlleGroupsAsHomologies_conf pipeline<br> members_db - should point to the=
 database that contains all members</p>
<p style=3D"font-size: 10.0pt;line-height: 13.0pt;color: rgb(0,0,0);font-we=
ight: normal;margin-bottom: 10.0px;">Also choose the server to run the merg=
ing pipeline on ( you don't need a lot of resources or memory, as it is pur=
ely Hive book-keeping ) and set the 'host' default_option.</p>
<p>&nbsp;&nbsp;&nbsp; Save the changes, exit the editor, init and run the m=
erging pipeline with this file:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>running the merging pipeline</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::EBI::Ensembl::MergeDBsIntoRele=
ase_conf.pm
beekeeper.pl ... -sync
runWorker.pl ... -job_id 1
# If the first job passes
beekeeper.pl ... -loop</pre>=20
</div>
</div>
<p>&nbsp;&nbsp;&nbsp; This pipeline will merge all the protein-side product=
s into the release database.</p>
<p>**** NOTE: you may have to do some cleaning of the mouse strain db e.g. =
deleting some duplicated mlss ids.</p>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<p class=3D"title">Merge family members</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Members are exclusively copied from the members db, but extra members ne=
ed to be merged from the families pipeline database. This includes gene_mem=
bers, seq_members and sequences with a dbID &gt;=3D 900000001</p>
</div>
</div>
</div>
</div></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"507"><p>Load the species-trees=
 (needed for <a href=3D"http://www.ensembl.org/info/about/speciestree.html"=
 class=3D"external-link" rel=3D"nofollow">the Species-tree view</a>)</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">$ init_=
pipeline.pl Bio::EnsEMBL::Compara::PipeConfig::LoadSpeciesTrees_conf -compa=
ra_alias_name compara_curr -host mysql-ens-compara-prod-1 -port 4485
# Then run beekeeper as suggested by init_pipeline.pl</pre>=20
</div>
</div><p># Note: the last analysis of this pipeline failed in rel.82 (all 4=
 jobs of this analysis) trying to insert duplicated entries into MLSS_tag t=
able, but all the data was there, so I just carried on. same in rel.85</p><=
p><br></p></li>
<li class=3D"checked" data-inline-task-id=3D"568"><p>Run the <code>Bio::Ens=
EMBL::Compara::PipeConfig::Example::EnsemblPostHomologyMerge_conf</code> pi=
peline:</p>
<div id=3D"expander-1291366321" class=3D"expand-container">
<div id=3D"expander-control-1291366321" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-1291366321" class=3D"expand-content">
<p>This pipeline combines a few pipelines we have to run at this stage: Gen=
eMemberHomologyStats_conf and HighConfidenceOrthologs_conf. Each of these c=
an be disabled with a flag, and they're also all available as a standalone =
pipelines.</p>
<ul>
<li><u>GeneMemberHomologyStats_conf</u>. It populates the gene_member_hom_s=
tats table (absence/presence of gene-tree, number of orthologues, etc) whic=
h is used by Web to grey out the menu items. This part comes pre-seeded wit=
h two jobs (one for the <em>default</em> collection and one for the&nbsp;<e=
m>murinae</em> collection).</li>
<li><u>HighConfidenceOrthologs_conf</u>. This pipeline marks some orthologu=
es as high-confidence based on their % identity, GOC and WGA scores. Becaus=
e GOC is not computed on ncRNAs, the pipeline has two stream of jobs: one f=
or protein-coding genes and one for ncRNAs. <img class=3D"emoticon emoticon=
-warning" title=3D"(warning)" border=3D"0" src=3D"88c456168bf05fd8889741fc3=
e7415df" alt=3D"(warning)"> This needs the WGA scores to be in !</li>
</ul>
<p><a href=3D"http://init_pipeline.pl" class=3D"external-link" rel=3D"nofol=
low">init_pipeline.pl</a> Bio::EnsEMBL::Compara::PipeConfig::Example::Ensem=
blPostHomologyMerge_conf -compara_db mysql://ensadmin:${ENSADMIN_PSW}@mysql=
-ens-compara-prod-1:4485/ensembl_compara_88</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"510"><p><span style=3D"color: =
rgb(112,112,112);">Drop the three databases used for merging.</span></p>
<div id=3D"expander-84538576" class=3D"expand-container">
<div id=3D"expander-control-84538576" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-84538576" class=3D"expand-content">
<p><br></p>
<div>
<p><br></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">=09# Af=
ter you are happy about the result of protein side merging you can drop the=
 "YourName_homology_projections_ThisRelease" database.
$ db_cmd.pl -url mysql://ensadmin:${ENSADMIN_PSW}@compara5/lg4_homology_pro=
jections_${CURR_ENSEMBL_RELEASE} -sql 'drop database'
&nbsp;
=09# same for the LoadSpeciesTrees database:
$ db_cmd.pl -url mysql://ensadmin:${ENSADMIN_PSW}@compara5/lg4_load_species=
_trees_${CURR_ENSEMBL_RELEASE} -sql 'drop database'

=09# same for the MergeDBsIntoRelease database:
$ db_cmd.pl -url mysql://ensadmin:${ENSADMIN_PSW}@compara5/lg4_pipeline_dbm=
erge_${CURR_ENSEMBL_RELEASE} -sql 'drop database'</pre>=20
</div>
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"509"><p><span style=3D"line-he=
ight: 1.4285715;">git commit the changes to the PipeConfig files that you h=
ave made.</span></p></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Finaldatabasechecks"><span>Final=
 database checks<br> </span></h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"524"><p><span>Remove redundant=
 method_link entries</span></p>
<div id=3D"expander-600497737" class=3D"expand-container">
<div id=3D"expander-control-600497737" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-600497737" class=3D"expand-content">
<p>In most cases they can be removed, but check with other members of Compa=
ra. Remove redundant method_link entries</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>method_link entries</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: sql; gutter: false; theme: Confluence" data-theme=3D"Confluence">-- prepe=
nd with:     db_cmd.pl -reg_conf $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scri=
pts/pipeline/production_reg_ebi_conf.pl -reg_alias compara_curr -sql
&nbsp;
SELECT ml.* FROM method_link ml LEFT JOIN method_link_species_set mlss USIN=
G(method_link_id) WHERE mlss.method_link_id IS NULL;
DELETE ml FROM method_link ml LEFT JOIN method_link_species_set mlss USING(=
method_link_id) WHERE mlss.method_link_id IS NULL;
&nbsp;
note**** we deleted 18 mlss_ids in rel.83, rel.86 &amp; rel.88, rel.89; 19 =
in rel. 90; 19 in rel 93 and 94;</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"198"><p>Check that all the sch=
ema patches have been declared and applied.</p>
<div id=3D"expander-1255154294" class=3D"expand-container">
<div id=3D"expander-control-1255154294" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1255154294" class=3D"expand-content">
<p>If unsure, recheck the current schema against the previous schema. See<s=
pan> <span class=3D"confluence-link">Check the patch files</span> for detai=
ls </span></p>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Runthehealthchecks"><span>Run th=
e healthchecks</span></h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"478"><p><span>Update the code<=
/span></p>
<div id=3D"expander-1506419203" class=3D"expand-container">
<div id=3D"expander-control-1506419203" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1506419203" class=3D"expand-content">
<p>The healthchecks are written in java and need to be recompiled after a g=
it pull.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>compile healthchecks</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensj-healthcheck
export JAVA_HOME=3D/nfs/software/ensembl/latest/linuxbrew/opt/jdk@8
git pull
bsub -I ant clean jar</pre>=20
</div>
</div>
<p>We don't need to configure a database.properties any more. Everything is=
 done from the command line</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"574"><p>&nbsp;Run the healthch=
ecks for ancestral database</p>
<div id=3D"expander-1183060415" class=3D"expand-container">
<div id=3D"expander-control-1183060415" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1183060415" class=3D"expand-content">
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -M8000  -R"select[mem&gt;8000]  rusage[mem=3D8000]" -I ./run-configurabl=
e-testrunner.sh $(mysql-ens-compara-prod-1 details script) -d mateus_ensemb=
l_ancestral_88 --release $CURR_ENSEMBL_RELEASE -g ComparaAncestral</pre>=20
</div>
</div>
<p>It should take less than a minute (if the tables are analyzed / optimize=
d) and usually complains about 1 thing that you can ignore:</p>
<div class=3D"preformatted panel" style=3D"border-width: 1px;">
<div class=3D"preformattedContent panelContent">=20
<pre>org.ensembl.healthcheck.testcase.generic.AssemblySeqregion [Team respo=
nsible: GENEBUILD]
  mm14_ensembl_ancestral_80: 0 rows found in assembly table</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>If healthcheck indicates that tables need to be analysed, follow instruc=
tions here: <a href=3D"/seqdb/confluence/pages/viewpage.action?pageId=3D309=
48447">Analyze / Optimize the databases</a></p>
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"575"><p><span>Update the max_a=
lignment_length IF NECESSARY.</span></p>
<div id=3D"expander-1665967651" class=3D"expand-container">
<div id=3D"expander-control-1665967651" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1665967651" class=3D"expand-content">
<p>Check that the max_alignment_lengths have been computed.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>update max_alignment_length</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -I ./run-configurable-testrunner.sh $(mysql-ens-compara-prod-1 details s=
cript) -d ensembl_compara_88 --release $CURR_ENSEMBL_RELEASE -t org.ensembl=
.healthcheck.testcase.compara.MLSSTagMaxAlign</pre>=20
</div>
</div>
<p>If not (the healthcheck is failing), you can repair it by adding the --r=
epair flag:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>update max_alignment_length</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -I ./run-configurable-testrunner.sh -h compara5 -d sf5_ensembl_compara_7=
7 --release $CURR_ENSEMBL_RELEASE -t org.ensembl.healthcheck.testcase.compa=
ra.MLSSTagMaxAlign --repair 1 --user ensadmin --password $ENSADMIN_PSW</pre=
>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"576"><p>Update the alignment m=
lss_id of the conservation score IF NECESSARY</p>
<div id=3D"expander-1899323161" class=3D"expand-container">
<div id=3D"expander-control-1899323161" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1899323161" class=3D"expand-content">
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>update conservation score mlss_id</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -I ./run-configurable-testrunner.sh $(mysql-ens-compara-prod-1 details s=
cript) -d ensembl_compara_88 --release $CURR_ENSEMBL_RELEASE -t org.ensembl=
.healthcheck.testcase.compara.MLSSTagGERPMSA</pre>=20
</div>
</div>
<p>If the healthcheck is failing, you can repair it by adding the --repair =
flag:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>update conservation score mlss_id</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -I ./run-configurable-testrunner.sh -h compara5 -d sf5_ensembl_compara_7=
7 --release $CURR_ENSEMBL_RELEASE -t org.ensembl.healthcheck.testcase.compa=
ra.MLSSTagGERPMSA --repair 1 --user ensadmin --password $ENSADMIN_PSW</pre>=
=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"577"><p>Run the ComparaAll gro=
up of healthchecks on the release database. NOTE: If pressed for time, this=
 test can divided into 2 separate tests that can be run simultaneously to s=
ave some time. You just have substitute "ComparaAll" in the code block belo=
w to "ComparaHomology" in one run and "ComparaGenomic" in the other run</p>
<div id=3D"expander-1484769906" class=3D"expand-container">
<div id=3D"expander-control-1484769906" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1484769906" class=3D"expand-content">
<p>The 'stdbuf -o0' is a trick to prevent the pipe from buffering the outpu=
t, since in addition to storing it we also want to examine the output visua=
lly.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -M8000  -R"select[mem&gt;8000]  rusage[mem=3D8000]" -I stdbuf -o0 ./run-=
configurable-testrunner.sh $(mysql-ens-compara-prod-1 details script) -d en=
sembl_compara_88 --release $CURR_ENSEMBL_RELEASE -g ComparaAll | tee health=
checks_after_merge.txt</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"526"><p>Run the ControlledComp=
araTables group of healthchecks on the release database</p>
<div id=3D"expander-79193" class=3D"expand-container">
<div id=3D"expander-control-79193" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-79193" class=3D"expand-content">
<p>The 'stdbuf -o0' is a trick to prevent the pipe from buffering the outpu=
t, since in addition to storing it we also want to examine the output visua=
lly.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>compara_external_foreign_keys</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -M8000  -R"select[mem&gt;8000]  rusage[mem=3D8000]" -I stdbuf -o0 ./run-=
configurable-testrunner.sh $(mysql-ens-compara-prod-1 details script) -d en=
sembl_compara_89 --release 89 --compara_master.database ensembl_compara_mas=
ter -g ControlledComparaTables | tee healthchecks_controlled_tables_after_m=
erge.txt</pre>=20
</div>
</div>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"590"><p>Run the ComparaSanity =
group of healthchecks on the release database</p>
<div id=3D"expander-1070769799" class=3D"expand-container">
<div id=3D"expander-control-1070769799" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1070769799" class=3D"expand-content">
<p>"Sanity" tests are tested that are expected to fail and have to be manua=
lly approved</p>
<p>The 'stdbuf -o0' is a trick to prevent the pipe from buffering the outpu=
t, since in addition to storing it we also want to examine the output visua=
lly.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>compara_external_foreign_keys</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">time bs=
ub -M8000  -R"select[mem&gt;8000]  rusage[mem=3D8000]" -I stdbuf -o0 ./run-=
configurable-testrunner.sh $(mysql-ens-compara-prod-1 details script) -d en=
sembl_compara_89 --release 89 --compara_master.database ensembl_compara_mas=
ter -g ComparaSanity | tee healthchecks_sanity_after_merge.txt</pre>=20
</div>
</div>
<p>Typically, there are three failures:</p>
<ul>
<li><u>CheckConservationScoreSanity</u>: Most of the multiple-genome WGAs w=
ill have a few blocks with no conservation scores. This is fine as long as =
it's only a few of them.</li>
<li><u>CheckSyntenySanity</u>: For distant species, some chromosomes may no=
t have any synteny blocks. Again, there shouldn't be more than a few.</li>
<li><u>CheckTableSizes</u>: This compares the size of each table to the pre=
vious versions of the database and complains if there is a significant chan=
ge (either way), if the tables have exactly the same size, or if some table=
s have appeared / disappeared. As the relco, you need to check that all the=
 differences correspond to schema or dataset changes</li>
</ul>
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Testwebserver">Test web server</=
h2>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li class=3D"checked" data-inline-task-id=3D"185"><p><span>Ask web's relco =
to point the test web server to the compara release database</span></p></li=
>
<li class=3D"checked" data-inline-task-id=3D"603"><p><span>Follow instructi=
ons <a href=3D"/seqdb/confluence/display/EnsCom/Testing+the+staging+website=
">here to test staging data</a> </span></p></li>
</ul>
<p><br></p>
<h2 id=3D"Releasecoordinationdocumentation-Finalhandoverofdatabases[edit]">=
Final handover of databases <a href=3D"https://www.ebi.ac.uk/seqdb/confluen=
ce/pages/editpage.action?pageId=3D30948157" rel=3D"nofollow">[edit]</a></h2=
>
<p></p>
<h3 id=3D"Releasecoordinationdocumentation-Handover">Handover</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"30948157">
<li class=3D"checked" data-inline-task-id=3D"3"><p>Let the production team =
know that our database is ready, and where. From this point onwards, everyb=
ody <strong>hands-off</strong> the database. Nothing is allowed to change i=
n it</p></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"30948157">
<li data-inline-task-id=3D"16"><p><span>Generate a new Age of Base file</sp=
an></p>
<div id=3D"expander-1654937886" class=3D"expand-container">
<div id=3D"expander-control-1654937886" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for more information...</spa=
n>
</div>
<div id=3D"expander-content-1654937886" class=3D"expand-content">
<p>If the mammals EPO alignment has been rerun, we will need to generate a =
new Age of Base file for <u>human only</u>. This can be done using the foll=
owing pipeline:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::EBI::BaseAge_conf -pipeline_na=
me human_base_age_${release_number}</pre>=20
</div>
</div>
<p>The pipeline will generate a number of .<code style=3D"letter-spacing: 0=
.0px;">bed</code> files and one bigBed ( <code style=3D"letter-spacing: 0.0=
px;">.bb</code> ) file. Copy the <code style=3D"letter-spacing: 0.0px;">.bb=
</code> to the following location, adhering to the naming standard <code st=
yle=3D"letter-spacing: 0.0px;">Hsap_ages_${epo_mlss_id}_${release_number}.b=
b</code> :</p>
<p><code>/nfs/production/panda/ensembl/production/ensemblftp/data_files/hom=
o_sapiens/GRCh38/compara/</code></p>
<p>Let the web-team know if you have copied a new file or if they should co=
nsider the file from the previous release. Usually, they prefer to get this=
 information as a Jira ticket.</p>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<p class=3D"title">NB</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p><span style=3D"color: rgb(112,112,112);">The newest variation database m=
ust be handed over before running this pipeline</span></p>
</div>
</div>
</div>
</div><p><span><br></span></p></li>
<li class=3D"checked" data-inline-task-id=3D"13"><span>Update the Declarati=
on of Intentions on the <a href=3D"http://admin.ensembl.org/index.html" cla=
ss=3D"external-link" rel=3D"nofollow">admin website</a> to indicate what ha=
s been handed over and what didn't make it and has been postponed</span></l=
i>
</ul>
<h3 id=3D"Releasecoordinationdocumentation-Finalbits">Final bits</h3>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"30948157">
<li class=3D"checked" data-inline-task-id=3D"14"><p>Dump the master databas=
e and place the copy in a safe place</p>
<div id=3D"expander-1644501453" class=3D"expand-container">
<div id=3D"expander-control-1644501453" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-1644501453" class=3D"expand-content">
<p>It should take a couple of minutes at most to run:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>dump master database</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">become =
-- compara_ensembl
db_cmd.pl $COMPARA_REG compara_master --executable mysqldump | gzip - &gt; =
/nfs/production/panda/ensembl/warehouse/compara/master_db_dumps/ensembl_com=
para_master_${CURR_ENSEMBL_RELEASE}.mysql.gz</pre>=20
</div>
</div>
</div>
</div></li>
</ul>
<p><br></p>
<p></p>
<h1 id=3D"Releasecoordinationdocumentation-Post-handover">Post-handover</h1=
>
<h2 id=3D"Releasecoordinationdocumentation-Updatedocumentationanddiagrams[e=
dit]">Update documentation and diagrams <a href=3D"https://www.ebi.ac.uk/se=
qdb/confluence/pages/editpage.action?pageId=3D32180001" rel=3D"nofollow">[e=
dit]</a></h2>
<p><br></p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"32180001">
<li class=3D"checked" data-inline-task-id=3D"470"><p>Update the pipeline di=
agrams for all the pipelines that have been run this release</p>
<div id=3D"expander-1611210867" class=3D"expand-container">
<div id=3D"expander-control-1611210867" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1611210867" class=3D"expand-content">
<p>Go to the docs directory</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>pipeline diagrams</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cd $ENS=
EMBL_CVS_ROOT_DIR/ensembl-compara/docs/production/diagrams

generate_graph.pl $COMPARA_REG compara_ptrees -output ProteinTrees.png
**At the current time, due to the size of the protein tree db, we have to u=
se the older version of "dot" which is not in the linuxbrew environment. fo=
r this to work 1) export PATH=3D/usr/bin/:$PATH 2) export PATH=3D/nfs/softw=
are/ensembl/RHEL7-JUL2017-core2/plenv/shims:/nfs/software/ensembl/RHEL7-JUL=
2017-core2/plenv/bin/:$PATH

generate_graph.pl $COMPARA_REG compara_nctrees -output ncRNAtrees.png
generate_graph.pl $COMPARA_REG compara_families -output Families.png
generate_graph.pl --url mysql://ensro@mysql-ens-compara-prod-1:4485/mateus_=
dump_release_93 -out Dumps.png
generate_graph.pl --url mysql://ensro@mysql-ens-compara-prod-2:4522/mateus_=
amniotes_mercator_pecan_93 -output MercatorPecan.png
generate_graph.pl --url mysql://ensro@mysql-ens-compara-prod-2.ebi.ac.uk:45=
22/muffato_mammals_epo_low_coverage_93 -output EpoLowCoverage.png
generate_graph.pl -url mysql://ensro@mysql-ens-compara-prod-2.ebi.ac.uk:452=
2/waakanni_mammals_epo_93 -output epo_pt3.png
</pre>=20
</div>
</div>
<p>Commit any changed diagrams to git and push.</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"467"><p>Update the schema docu=
mentation and diagrams</p>
<div id=3D"expander-1574146753" class=3D"expand-container">
<div id=3D"expander-control-1574146753" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1574146753" class=3D"expand-content">
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>generate new schema documentation</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl $E=
NSEMBL_CVS_ROOT_DIR/ensembl-production/scripts/sql2html.pl -i $ENSEMBL_CVS_=
ROOT_DIR/ensembl-compara/sql/table.sql -o $ENSEMBL_CVS_ROOT_DIR/public-plug=
ins/docs/htdocs/info/docs/api/compara/compara_schema.html -d Compara $(mysq=
l-ens-compara-prod-1 details script) -dbname ensembl_compara_$CURR_ENSEMBL_=
RELEASE -sort_headers 0 -sort_tables 0 -intro $ENSEMBL_CVS_ROOT_DIR/ensembl=
-compara/docs/schema_intro.html -out_diagram_dir diagrams</pre>=20
</div>
</div>
<p>Open the output file <code>$ENSEMBL_CVS_ROOT_DIR/public-plugins/docs/htd=
ocs/info/docs/api/compara/compara_schema.html</code> in your browser and ch=
eck that no example errors are reported.</p>
<p>If everything looks fine, commit&amp;push public-plugins.</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"462"><p>Update the API tutoria=
l documentation</p>
<div id=3D"expander-1698599638" class=3D"expand-container">
<div id=3D"expander-control-1698599638" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1698599638" class=3D"expand-content">
<p>Update the tutorial documentation compara_tutorial.html in this director=
y: <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-webcode/htdocs/info/docs/api/compara=
/</code></p>
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
Be careful that the embedded Perl snippets must use HTML-escaped characters=
 (e.g. &amp;lt; and &amp;gt;) and be wrapped in a=20
<code>&lt;pre class=3D"code sh_perl"&gt;</code>
</div>
</div>
<p>Open the URL /info/docs/api/compara/compara_tutorial.html from a sandbox=
 / test website and export it as a PDF in <code>$ENSEMBL_CVS_ROOT_DIR/ensem=
bl-compara/docs/ComparaTutorial.pdf</code></p>
<p>To make the pdf look nicer, you can issue a few JavaScript commands to r=
emove the Ensembl headers. See <a href=3D"/seqdb/confluence/display/EV/Crea=
ting+PDF+version+of+VEP+docs">Creating PDF version of VEP docs</a> for more=
 details</p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"464"><p>Update the tutorial ab=
out Compara resources</p>
<div id=3D"expander-1615877452" class=3D"expand-container">
<div id=3D"expander-control-1615877452" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here to expand...</span>
</div>
<div id=3D"expander-content-1615877452" class=3D"expand-content">
<p>Do the same with <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-webcode/htdocs/info=
/website/tutorials/compara.html</code>&nbsp;. This pages can be viewed onli=
ne at <a href=3D"http://staging.ensembl.org/info/website/tutorials/compara.=
html" class=3D"external-link" rel=3D"nofollow"> http://staging.ensembl.org/=
info/website/tutorials/compara.html </a></p>
</div>
</div></li>
<li class=3D"checked" data-inline-task-id=3D"210">Check examples work in en=
sembl-compara/scripts/examples/</li>
<li data-inline-task-id=3D"420"><p>Create a word document and a pdf dump of=
 this document</p>
<div id=3D"expander-1654622821" class=3D"expand-container">
<div id=3D"expander-control-1654622821" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">Click here for details</span>
</div>
<div id=3D"expander-content-1654622821" class=3D"expand-content">
<p>In the top-right menu of this Confluence page, choose "Tools -&gt; Expor=
t to PDF" and "Tools -&gt; Export to Word".</p>
<p>Put these files into <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-compara/docs/pr=
oduction</code></p>
</div>
</div></li>
<li data-inline-task-id=3D"286">git commit and push any modified files or a=
dded tutorial examples</li>
</ul>
<p></p>
<h2 id=3D"Releasecoordinationdocumentation-Testthesites">Test the sites</h2=
>
<p>Once the branch is in, the web and core teams will set up the test sites=
. Each one has to be tested idealy following the same protocol as before th=
e handover</p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li data-inline-task-id=3D"552"><span>Main ensembl site <a href=3D"http://t=
est.ensembl.org" class=3D"external-link" rel=3D"nofollow">http://test.ensem=
bl.org</a> </span></li>
<li data-inline-task-id=3D"553"><span>GRCh37 site: <a href=3D"http://test.e=
nsembl.org" class=3D"external-link" rel=3D"nofollow">http://test.ensembl.or=
g</a> </span></li>
<li data-inline-task-id=3D"554"><p><span>Main REST server: <a href=3D"http:=
//test.rest.ensembl.org" class=3D"external-link" rel=3D"nofollow">http://te=
st.rest.ensembl.org</a> </span> <br>Open each Compara endpoint and check th=
at there is an output and that it is similar to the live site<span>&nbsp;</=
span> <br> <span>We now have a new script to automatically test compara res=
t endpoints</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl en=
sembl-compara/scripts/production/Verify_Compara_REST_Endpoints.pl http://e8=
9.rest.ensembl.org</pre>=20
</div>
</div><p><span> <br> </span></p></li>
<li data-inline-task-id=3D"555"><p><span>GRCh37 REST server: <a href=3D"htt=
p://test.grch37.rest.ensembl.org/" class=3D"external-link" rel=3D"nofollow"=
>http://test.grch37.rest.ensembl.org/</a> <br> </span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl en=
sembl-compara/scripts/production/Verify_Compara_REST_Endpoints.pl http://te=
st.grch37.rest.ensembl.org</pre>=20
</div>
</div></li>
</ul>
<h2 id=3D"Releasecoordinationdocumentation-Datadumps"><a href=3D"/seqdb/con=
fluence/display/EnsCom/Data+dumps">Data dumps</a></h2>
<p><br></p>
<p>Most dumps (except homology) are currently generated in <code>/hps/nobac=
kup/production/ensembl/${USER}/dumps_${release_number}</code>,&nbsp;areas a=
nd then have to be assembled into the&nbsp;<code>/nfs/production/panda/ense=
mbl/production/ensemblftp/release-XX/</code>&nbsp;tree.<br> Look at the pre=
vious release tree to get the idea. The first level of directories normally=
 defines the file type, and the second level is the team name (except <code=
>fasta/</code>&nbsp;where species are mixed).</p>
<p>Ensembl-compara is responsible for the following dumps:</p>
<ul>
<li><code>bed/ensembl-compara</code>&nbsp;(MSA)</li>
<li><code>emf/ensembl-compara</code>&nbsp;(MSA and homologies)</li>
<li><code>maf/ensembl-compara</code>&nbsp;(multiple_alignments and pairwise=
_alignments)</li>
<li><code>tsv/ensembl-compara</code>&nbsp;(homologies)</li>
<li><code>xml/ensembl-compara</code>&nbsp;(homologies)</li>
<li><code>fasta/ancestral_alleles</code>&nbsp;(the only one without ensembl=
-compara in the path)</li>
<li><code>compara/</code></li>
</ul>
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>All dumps have to be present in the release-XX tree, either newly genera=
ted by running pipelines,&nbsp;or copied over from the previous release (e.=
g. if some MSAs did not run in this release).<br>Compare to the previous re=
lease and check that we have more / bigger files.</p>
</div>
</div>
<p><br></p>
<p>A new pipeline was implemented to perform all the dumps:</p>
<div class=3D"panel" style=3D"border-width: 1px;">
<div class=3D"panelHeader" style=3D"border-bottom-width: 1px;">
<b>Run this pipeline:</b>
</div>
<div class=3D"panelContent">=20
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"71139824">
<li class=3D"checked" data-inline-task-id=3D"573"><a href=3D"/seqdb/conflue=
nce/display/EnsCom/DumpAllForRelease+for+e93">DumpAllForRelease for e93</a>=
</li>
</ul>=20
</div>
</div>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"71139824">
<li class=3D"checked" data-inline-task-id=3D"572"><span style=3D"color: rgb=
(94,108,132);">Let the production team know that the dumps are ready in the=
ir common location.</span></li>
</ul>
<p><br></p>
<div class=3D"panel" style=3D"border-width: 1px;">
<div class=3D"panelHeader" style=3D"border-bottom-width: 1px;">
<b>This is now obsolete </b>
</div>
<div class=3D"panelContent">=20
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>All the copying has to be done with the <code>compara_ensembl</code> vir=
tual user:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: bash; gutter: false; theme: Confluence" data-theme=3D"Confluence">become =
-- compara_ensembl</pre>=20
</div>
</div>
</div>
</div>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"71139824">
<li data-inline-task-id=3D"565">
<div id=3D"expander-721268080" class=3D"expand-container">
<div id=3D"expander-control-721268080" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">BED files</span>
</div>
<div id=3D"expander-content-721268080" class=3D"expand-content">
<p>The <code>bed/ensembl-compara/</code> directory should contain dumps of =
constrained elements calculated on (a) EPO low coverage alignments and (b) =
Pecan alignments. If there have been new runs of these pipelines during the=
 release, the data must be re-dumped. Otherwise, they can be copied from th=
e last release.</p>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>The constrained elements mlss_id should be passed to this pipeline!</p>
</div>
</div>
<p>The files can be generated using the following pipeline:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::DumpConstrainedElements_conf -=
-compara_url $COMPARA_DB --registry $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/s=
cripts/pipeline/production_reg_ebi_conf.pl --mlss_id $CE_MLSS_ID</pre>=20
</div>
</div>
</div>
</div></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"71139824">
<li data-inline-task-id=3D"568">
<div id=3D"expander-306467070" class=3D"expand-container">
<div id=3D"expander-control-306467070" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">EMF &amp; MAF (Alignments)</span>
</div>
<div id=3D"expander-content-306467070" class=3D"expand-content">
<div class=3D"confluence-information-macro confluence-information-macro-war=
ning">
<span class=3D"aui-icon aui-icon-small aui-iconfont-error confluence-inform=
ation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Ensure that the environment variable <code>$CURR_ENSEMBL_RELEASE</code> =
is set before running this pipeline! If it is not set, the pipeline will du=
mp <strong>everything</strong>, rather than just freshly-run pipelines (fre=
shly-run =3D MLSSes where <code>first_release &gt;=3D $CURR_ENSEMBL_RELEASE=
</code>)</p>
</div>
</div>
<p>Data can be dumped in these formats for both multiple and pairwise align=
ments using the following pipeline:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence"># MSA p=
ipeline settings
init_pipeline.pl Bio::EnsEMBL::Compara::PipeConfig::DumpMultiAlign_conf --c=
ompara_db $RELEASE_DB --registry $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scri=
pts/pipeline/production_reg_ebi_conf.pl --format emf+maf --method_link_type=
s EPO:PECAN:EPO_LOW_COVERAGE

# pairwise pipeline settings
init_pipeline.pl Bio::EnsEMBL::Compara::PipeConfig::DumpMultiAlign_conf --c=
ompara_db $RELEASE_DB --registry $ENSEMBL_CVS_ROOT_DIR/ensembl-compara/scri=
pts/pipeline/production_reg_ebi_conf.pl --format maf --method_link_types LA=
STZ_NET --make_tar_archive 1</pre>=20
</div>
</div>
<ul>
<li>Formats:
<ul>
<li>For multiple alignments, the format should be "emf+maf"</li>
<li>For pairwise alignments, the format should be "maf" only</li>
</ul></li>
<li><code>--method_link_types</code> can be replaced with <code>--mlss_id</=
code> in cases where only select alignments should be dumped ( --<code>meth=
od_link_types</code> will result in <u> <em>all</em> </u> matching alignmen=
ts being dumped)</li>
<li><code>--make_tar_archive</code> should be set to true for pairwise alig=
nments</li>
</ul>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Further information can be found at <code>$ENSEMBL_CVS_ROOT_DIR/ensembl-=
compara/docs/production/READMEs/multi_align.dumps.rst</code></p>
</div>
</div>
</div>
</div></li>
</ul>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"71139824">
<li data-inline-task-id=3D"563">
<div id=3D"expander-239670659" class=3D"expand-container">
<div id=3D"expander-control-239670659" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">EMF, TSV &amp; XML (Homologies)</span>
</div>
<div id=3D"expander-content-239670659" class=3D"expand-content">
<p>Check all parameters in <code>Bio::EnsEMBL::Compara::PipeConfig::DumpTre=
es_conf</code>. This config file defines parameters for each set of trees, =
but we will use a wrapper pipeline, <code>DumpAllTrees_conf,</code> to dump=
 everything (inheriting params from DumpTrees_conf).</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>init_pipelline</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl DumpAllTrees_conf.pm -dump_per_species_tsv 1 -host mysql-ens-comp=
ara-prod-1.ebi.ac.uk -port 4485</pre>=20
</div>
</div>
<p>The pipeline will produce tree dumps in the defined <code>target_dir</co=
de></p>
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<p class=3D"title">Copy tree content dump for Uniprot</p>
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>The file <code>#target_dir#/ensembl.GeneTree_content.${release_number}.t=
xt.gz</code> needs to be copied to the EBI ftp server, and then MD5 checksu=
m computed and stored next to it.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">cp /nfs=
/production/panda/ensembl/compara/${USER}/dumps_XX/ensembl.GeneTree_content=
.e81.txt.gz /nfs/ftp/pub/databases/ensembl/ensembl_compara/gene_trees_for_u=
niprot/
cd /nfs/ftp/pub/databases/ensembl/ensembl_compara/gene_trees_for_uniprot
md5sum ensembl.GeneTree_content.e&lt;CURR_RELEASE_NUMBER&gt;.txt.gz &gt; en=
sembl.GeneTree_content.e&lt;CURR_RELEASE_NUMBER&gt;.txt.gz.MD5SUM</pre>=20
</div>
</div>
</div>
</div>
</div>
</div></li>
<li data-inline-task-id=3D"571">
<div id=3D"expander-2143736432" class=3D"expand-container">
<div id=3D"expander-control-2143736432" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">compara/</span>
</div>
<div id=3D"expander-content-2143736432" class=3D"expand-content">
<h3 id=3D"Releasecoordinationdocumentation-SpeciesTrees">Species Trees</h3>
<p>Species trees should be dumped and placed in <code>release-XX/compara/sp=
ecies_trees/</code>. All species trees in a database can be dumped using a =
single pipeline run:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::DumpSpeciesTrees_conf --compar=
a_url mysql://ensro@mysql-ens-compara-prod-1:4485/ensembl_compara_XX</pre>=
=20
</div>
</div>
<p>Alternatively, individual trees can be dumped using the <code>ensembl-co=
mpara/scripts/example/<a href=3D"http://species_getSpeciesTree.pl" class=3D=
"external-link" rel=3D"nofollow">species_getSpeciesTree.pl</a></code> scrip=
t:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">perl sp=
ecies_getSpeciesTree.pl -url mysql://ensro@mysql-ens-compara-prod-1.ebi.ac.=
uk:4485/ensembl_compara_XX -mlss_id 60004 -label 'NCBI Taxonomy'</pre>=20
</div>
</div>
<h3 id=3D"Releasecoordinationdocumentation-TreeFamHMMs">TreeFam HMMs</h3>
<p>A dump of all HMM profiles used in TreeFam should be created and moved t=
o <code>release-XX/compara/multi_division_hmm_lib.tar.gz</code>. The file i=
s generated once when the library is created (outside of the production cyc=
le), and then copied over release to release.</p>
</div>
</div></li>
<li data-inline-task-id=3D"569">
<div id=3D"expander-79559498" class=3D"expand-container">
<div id=3D"expander-control-79559498" class=3D"expand-control">
<span class=3D"expand-control-icon"><img style=3D"vertical-align:middle;" c=
lass=3D"expand-control-image" src=3D"e1b6856f0402c08f135e43102c145f4a" widt=
h=3D"16" height=3D"16"></span>
<span class=3D"expand-control-text">fasta/ancestral_alleles</span>
</div>
<div id=3D"expander-content-79559498" class=3D"expand-content">
<div class=3D"confluence-information-macro confluence-information-macro-not=
e">
<span class=3D"aui-icon aui-icon-small aui-iconfont-warning confluence-info=
rmation-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>Ancestral alleles are computed from EPO data and can be copied from the =
previous release if no new alignments have been run</p>
</div>
</div>
<p>Ancestral sequences for the members of the primate EPO can be dumped usi=
ng a mini-pipeline:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">init_pi=
peline.pl Bio::EnsEMBL::Compara::PipeConfig::DumpAncestralAlleles_conf -hos=
t mysql-ens-compara-prod-X -port XXXX</pre>=20
</div>
</div>
<div class=3D"confluence-information-macro confluence-information-macro-inf=
ormation">
<span class=3D"aui-icon aui-icon-small aui-iconfont-info confluence-informa=
tion-macro-icon"></span>
<div class=3D"confluence-information-macro-body">
<p>These are required by the variation team - update them when dumps have c=
ompleted.</p>
</div>
</div>
</div>
</div></li>
</ul>=20
</div>
</div>
<p></p>
<p><br></p>
<ul class=3D"inline-task-list" data-inline-tasks-content-id=3D"21174007">
<li data-inline-task-id=3D"637"><p><span>Backup the master database (one la=
st time)</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">mysql-e=
ns-compara-prod-1 mysqldump ensembl_compara_master &gt; /nfs/production/pan=
da/ensembl/warehouse/compara/master_db_dumps/ensembl_compara_master.$(date =
'+%Y%m%d').post${CURR_ENSEMBL_RELEASE}.sql</pre>=20
</div>
</div><p><span> <br> </span></p></li>
</ul>
    </div>
</body>
</html>
------=_Part_28872_1986318149.1534925491387
Content-Type: image/svg+xml
Content-Transfer-Encoding: 7bit
Content-Location: file:///C:/88c456168bf05fd8889741fc3e7415df

<svg width="16" height="16" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M9.756 1.723l5.627 10.32A2 2 0 0 1 13.627 15H2.373a2 2 0 0 1-1.756-2.957l5.627-10.32a2 2 0 0 1 3.512 0z" fill="#FFC400"/><path d="M9 8.8c0 .662-.448 1.2-1 1.2s-1-.538-1-1.2V5.2C7 4.538 7.448 4 8 4s1 .538 1 1.2v3.6zM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" fill="#253858"/></g></svg>
------=_Part_28872_1986318149.1534925491387
Content-Type: application/octet-stream
Content-Transfer-Encoding: base64
Content-Location: file:///C:/f8b17f04c9cf89158e086ecea6b31a57

iVBORw0KGgoAAAANSUhEUgAAADUAAAA4CAYAAABdeLCuAAABfGlDQ1BJQ0MgUHJvZmlsZQAAKJFj
YGAqSSwoyGFhYGDIzSspCnJ3UoiIjFJgv8PAzcDDIMRgxSCemFxc4BgQ4MOAE3y7xsAIoi/rgsxK
8/x506a1fP4WNq+ZclYlOrj1gQF3SmpxMgMDIweQnZxSnJwLZOcA2TrJBUUlQPYMIFu3vKQAxD4B
ZIsUAR0IZN8BsdMh7A8gdhKYzcQCVhMS5AxkSwDZAkkQtgaInQ5hW4DYyRmJKUC2B8guiBvAgNPD
RcHcwFLXkYC7SQa5OaUwO0ChxZOaFxoMcgcQyzB4MLgwKDCYMxgwWDLoMjiWpFaUgBQ65xdUFmWm
Z5QoOAJDNlXBOT+3oLQktUhHwTMvWU9HwcjA0ACkDhRnEKM/B4FNZxQ7jxDLX8jAYKnMwMDcgxBL
msbAsH0PA4PEKYSYyjwGBn5rBoZt5woSixLhDmf8xkKIX5xmbARh8zgxMLDe+///sxoDA/skBoa/
E////73o//+/i4H2A+PsQA4AJHdp4IxrEg8AAAFiaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8
eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQu
MCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1y
ZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAg
ICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIj4KICAgICAg
ICAgPGV4aWY6VXNlckNvbW1lbnQ+U2NyZWVuc2hvdDwvZXhpZjpVc2VyQ29tbWVudD4KICAgICAg
PC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+Cm7M3i4AAAoASURB
VGgF7Vp7TJVHFv/dB/cFCCggXQVB0VVpC75QQVqj3V27+0fdpvURTa27iabRGDe72Wi2rtGNJsa/
3EQ3NqaJqdbE1Eft1lpdBY0vEFHXQH2AD5CXCFwu93Iv9/HNnvPpd7lweXzfxa7GOMkw882cOXN+
c86cOTMXXUtLi8ArlvSvGB4ZzmtQ2rUq0HRrKySfQ/vQQYwwDmJsv0Mlfztqr36C9sazGDpmVTfa
Y8eOYe3atfB4PN3aQz/i4+NRUVER2qS6/rOA8rqqUHP5Q6SMeQcdLbYwYex2OywWC/bs2RPWpzQY
jZGLFvlIZfYepbPxFOpurEbmtJWIGToBj24d7UEBmEwmsCbmzJkT1vc8Gp4rqCd3tsNRfwgTZ2+G
UW8n+XQI+AM4cOAAJDzVmE6nw8WLFzEYTQwE/LmAkgIdqCv7I0xRwMR3/wHhq0CgsxJ6Uwb8AQm7
v/gCbk+Xo3U4HEhNTR1Itoj7Bw3K11GNmpKP8MbY32FY6mwEPKUQgcekJGatg9lsQuGZMzBExQWF
3Lt3L3bv3h38ft6VQYFyNZ1D/Y3PMHb6OljjUxFwX4WQnCSjgTJrRgdqQOV/JsJoikOULQ2xKR/A
ZnSBzfDnSrpIw6SWe7vQXvs1xs78HMaoAJnbHQLQCUFZKaNi3gekdtpXdvi9zfA6q9De/AgN92/g
/FUnfrg6CU53+LoKIRAbG4tDhw5FhDucYz9sJEmCo+0J7Lf/AqvFj/EFm8nUHpLJNcijBPxUBp5l
CT7HUVJUG4GifgIXZYxBUtoEJI8uwC/G3kD+tGu4Vp2LOsebYbNardawNrUNmjTVUHcP/z0+E1Py
P0Zq1u/hd5eSVtjcnjkBwYD8pC0fgXDC5yoi0E1hsuj0CTBacyEMOXhYfgICQzBi6kHoDeYw2kga
ulySitESLPjurIC9oRi+zlbojYmkCYoKJLechfDI5icCrWRqP/YKiKcRUisB/hGBjq8wOufXsNq8
FE5tViGBOhJNoJjlkUITOmwrUHF2Azrdfhgtk2mlWTsEjkH5m+EjQJA43uvfGQh/Hbz2L5GSmQ93
SxE89mvqpB6AStOeUni5ddkYN/0w7lz6EOlvL8KQ4bPgd52jwPURmWQJgSPNUbIk/o3qAQJM3ww4
0AK/5yYkLzkVee9xdzOkjlNIHZ+HB2XLMXp2CXR6kzw+0j8RgeLJzLETkPHOOdQUz0dC6y0kZ+SQ
cOdIyo4uWchtl5/9F+0VK8zRsbDFxmNI8lRYh82jRThPDuaKTBvoLIclfir129BWewjxqYu7eERQ
ixgUz2U0JyF91hmKJv6A+9eOIj37IzqriuQDWJaFHEanx40jxXmwRHkQF+3A5IxvkDg8BqPfmgej
LRp+XggKogLkdGISEvHvb3fh8t3LiI6OxtatW2U2Wv9o2lN6fTi5Tm8mz7UPpvj3cfvSVxD6t2GM
fo/k0JND6CBxBcrvtuHC9QCOXyBB90/F94VWXD/3Dfx+GwzmLFlmiczQZDEixlSP6mqKUmpqtGIJ
0mvSVCDALru3pEPS+L/DFDMedy7/FRk5+bDE/JZAuSgeNGLfvn3dwiTmwId3zU87MDp7BgLe20Tr
pEMcyBoXhyMrjvQ2ieq28KXvZ+iiRYvgdrthMHAYFJ7iRi7AyNyDuHfjIuyP62l/PXUY4ZRAQsZK
Cnbj4Giuhs6QTH5ST6GTC/7Olt7INbVpArVkyRL5LsRhTF/JOjQX6QVFaKx+jPq7l2i7SL2S6nQG
xKd9Cne7ncCQt9Pb4GlvIgf0y17ptTRqAsWa4nsQh0s9EwPldjZRg3kkUmcWwuVMohDJA5/PR/vH
H8xMw7Q6Qwz8Pi+xorrOjHa7G9FJv+nJWvO3pj3V0dFBZ85TLXGpAFHqSslSCFiROOkgdD99LoOR
4A1G5hyhc/Z52wkcR/IBAq6HvdGFzLc+1Qyi5wBNoJTBvMq88orGuOSsgAoth2Ruhl+ihfCyRijG
IDC1tbUovXIZ2UP/iYxxFng6TairasF9x7u49PW3Mg2/YSxcuFCZUlOpCZQCQjEfBUxoyYAUgCwJ
f3MKvT+dP38e3x9ch7ErbKiq1dGh7UBJmYQvvyunsRXymLi4OCxYsKDbOJmRij+qQSnCKjxZcC3g
eByfc5yj9bew5INYvDnzV3C3tcAnxmNx/p/wyZ9tcj8vANPxnKGLocw9UKkJlMKMX4MUDXDZWw4F
zP2ykJKXwqMLGJlYiYpbRjjb46GLpptwfB4Mxq54j4FwVuZQ5lVbqgalTMTOYs2aNfITlwKGJ1ME
UMrQNrNJIMbmwxuJHso+PG5yweWJw8fLP4PBNDSoHWUOHst1XohIkiZQCQkJ2LJlC9ra2mRH0RNU
1zdrT6JnMgkGvZeOAT8drRww6clkzahpuYO6+iZEWRJlwVl4BQTXOfMBz22RJNWg2JzY7JYvXx48
bxQPyH1KXXEaXQC7xFI0EZvwA/hFiZ/KWHg++7iPS56D25gPl5y1JtWgmprCr+U8GQvPAigrrZTc
riSuczsnLvkwdjqduHnzZjfTU+i5ZDBZWVlITk7WbIaqQSUlUXTwLBJQtNGzVIBwO9eVHAqI68yL
fxxYvXp1KI5udX6WvnLlimZAzETTw0u3WV/ij8jcy0sMiEV7DeolV1BQvNeaCi7FS155ramXXEFB
8QbUVEpKCiZNmoTMzEzwG0VVVVVw8P+rohzqaucbEBQz4t+JysvL5bhs586dank/F7rs7GxUVlZq
4qUKFHM0m81IS0uDy+UKTnDq1Cnk5eVh3rx5OHz4cLC9oKAA+/fvx7Rp01BYWCi3FxUVIT8/H5Mn
T8b8+fPx4MGDIH1ffdu2bUNDQwOWLVuGDRs2BOkHrPAvif1lipoFaUesW7dOjBkzRhAQmb65uVmM
GjVK0D9wCHpNFSNGjBAkgNxHvwKKxYsXi4cPHwZ50w/X4vjx44LHbdy4UdBVXVXf8OHDRXFxcZC2
P1mVPlUB7YkTJ3D9+nWsWrUKU6ZMkReKg02+MO7YsUP+5iC2pKQEs2bNkr9pEeSfOPmjrKxMvlbM
mDFD7uOnttzcXHR2dspmzVeO3vrYOiJJqkDRyoJWWH7dYVNjM2xsbITNZpNNiSdmkyJNBmUIvbWy
yYYKGBUVFbyT9dcXOibIWEVF9Z7i/bF06VKsXLlSvoJMnz4dT548ka8GXOecmJjY65S873hRlEf/
kydPYu7cufIvG/31MTO+bfMCakqKHfZV8p4qLS2Vbbq+vl6Qaxfr16+Xv8kZCLobCQIscnJyBHlJ
uZ33FF0Au+2DXbt2iWHDhglyFPJePH36dLC/v77t27eL9PR0sWnTpiB9X7Iq7YO+T/EZwhpjLSmX
wb5WlS+Zra2tvWq0vz42Ud53as1x0KD6AvAi21XvqRcppNa5X4PSumIviv6V1NT/AAyE7bpgmIJ2
AAAAAElFTkSuQmCC
------=_Part_28872_1986318149.1534925491387
Content-Type: image/png
Content-Transfer-Encoding: base64
Content-Location: file:///C:/e1b6856f0402c08f135e43102c145f4a

iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAA3NCSVQICAjb4U/gAAAAFVBMVEX/
//9wcHBwcHBwcHBwcHBwcHBwcHA3RenHAAAAB3RSTlMAZoiZzN3/SzZomQAAAAlwSFlzAAALEgAA
CxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAUdEVYdENy
ZWF0aW9uIFRpbWUANi8xLzEzOKlF0AAAACFJREFUCJljYCATsCgwqIAZTMnMyRAhsTABCIMxkVxT
GQCLcwHyUKXpLgAAAABJRU5ErkJggg==
------=_Part_28872_1986318149.1534925491387--
